# mission_impossible_streamlit.py
import time
import os
from datetime import datetime
import base64
import streamlit as st

# ==== OpenAI client ====
try:
    from openai import OpenAI
    _has_openai = True
except Exception:
    _has_openai = False

if _has_openai:
    client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))
else:
    client = None

# ==== ëª¨ë¸ í˜¸ì¶œ í—¬í¼ ====
def ask_llm(messages, model="gpt-4o-mini", max_tokens=800, temperature=0.7):
    """OpenAI í˜¸ì¶œ, ì‹¤íŒ¨ì‹œ ì˜ˆì™¸ ë°œìƒì‹œì¼œ callerê°€ ì²˜ë¦¬í•˜ê²Œ í•¨."""
    if client is None:
        raise RuntimeError("OpenAI client not configured")
    resp = client.chat.completions.create(
        model=model,
        messages=messages,
        max_tokens=max_tokens,
        temperature=temperature
    )
    return resp.choices[0].message.content

# ==== ê²Œì„ ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ (ì‚¬ìš©ì ì œê³µ) ====
BASE_PROMPT = """
ë„ˆëŠ” ë¯¸ì…˜ì„íŒŒì„œë¸” 7í¸(ë°ë“œ ë ˆì½”ë‹)ê³¼ 8í¸(íŒŒì´ë„ ë ˆì½”ë‹) ì„¸ê³„ê´€ì—ì„œ ì§„í–‰ë˜ëŠ” ì¸í„°ë™í‹°ë¸Œ ê²Œì„ì˜ ì§„í–‰ìì´ë‹¤.
í˜„ì¬ IMFì—ëŠ” ì—ë‹¨ í—ŒíŠ¸(íŒ€ì¥), ë²¤ì§€(í•´í‚¹ ê¸°ìˆ ì), ë£¨í„°(í­íƒ„ í•´ì œ ê¸°ìˆ ì)ê°€ ìˆìœ¼ë©°, ê²Œì„ ì°¸ì—¬ìì¸ 'ì‚¬ìš©ì{player_name}'ëŠ” ì´ë“¤ë¡œë¶€í„° IMF ìš”ì›ì§ì„ ì œì•ˆë°›ì€ ìƒí™©ì´ë‹¤.

### ê²Œì„ ê·œì¹™ ###
1. ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œë§Œ ì¶œë ¥í•œë‹¤.
2. ê° ìŠ¤í† ë¦¬ë§ˆë‹¤ ì£¼ì–´ì§„ ìŠ¤í† ë¦¬ í”„ë¡¬í”„íŠ¸ë§Œì„ ê¸°ë°˜ìœ¼ë¡œ ì„±ì‹¤íˆ ë‚´ìš©ì„ ìˆ˜í–‰í•œë‹¤. ë‹¨, ì‚¬ìš©ìì—ê²Œ ìì—°ìŠ¤ëŸ½ê²Œ ë‚´ìš©ì´ ì „ê°œë  ìˆ˜ ìˆë„ë¡ ì˜í™”ë‚˜ ì†Œì„¤ì²˜ëŸ¼ ë¬¸ë§¥ì´ë‚˜ ì–´íˆ¬, ë¬¸ì²´ ë“±ì„ ì¼ë¶€ ìˆ˜ì •í•œë‹¤.
3. ê° ìŠ¤í† ë¦¬ ì „ê°œë§ˆë‹¤ ì…ë ¥ëœ ë‚´ìš©ê³¼ ì¡°ê±´ì„ ë°˜ë“œì‹œ ì§€í‚¨ë‹¤.
4. ì‚¬ìš©ìì˜ ì…ë ¥ì— ë”°ë¼ ìŠ¤í† ë¦¬ë¥¼ ì´ì–´ê°€ë©°, ì˜ëª»ëœ ì…ë ¥ì´ë©´ ì¹œì ˆíˆ ë‹¤ì‹œ ìš”ì²­í•œë‹¤.
5. ì²˜ìŒ ì‚¬ìš©ìì˜ ì…ë ¥ìœ¼ë¡œ ìš”ì› ì´ë¦„ì„ {player_name}ìœ¼ë¡œ ì…ë ¥ ë°›ìœ¼ë©´, ì´í›„ {player_name}ì—ëŠ” ì‚¬ìš©ìë¡œë¶€í„° ì…ë ¥ë°›ì€ ì´ë¦„ë§Œì„ í˜¸ì¶œí•œë‹¤.
6. ì²˜ìŒ ì‚¬ìš©ìì˜ ìš”ì› ì´ë¦„ì„ ì…ë ¥ë°›ìœ¼ë©´, í™˜ì˜ ì¸ì‚¬ì™€ í•¨ê»˜ IMFì— í•©ë¥˜í•  ê²ƒì¸ì§€ë¥¼ ì§ˆë¬¸í•œë‹¤. (ë°˜ë“œì‹œ í•©ë¥˜í•  ìˆ˜ ìˆë„ë¡ ìœ ë„í•  ê²ƒ)
7. í•µì‹¬ ì‚¬ê±´:
   - ì„ë¬´ ë¸Œë¦¬í•‘: ì—”í‹°í‹°, í•µì ìˆ˜í•¨, CIA ë‚´ ìŠ¤íŒŒì´
   - ì—´ì‡  A: ì•Œë¼ë‚˜(í™”ì´íŠ¸ ìœ„ë„ìš°)ì™€ í‚¤íŠ¸ë¦¬ì§€ì˜ ê±°ë˜, ë³€ì¥ ì„ë¬´, ê°€ë©´ ë¬¸ì œ, ì¬ìš°ê¸°/ëª¸ì‹¸ì›€
   - ì—´ì‡  B: ê°€ë¸Œë¦¬ì—˜ì´ ì†Œìœ , í•¨ì •ê³¼ ì¶”ê²©
   - ìµœì¢…: A+B í•©ì²´ â†’ ì—”í‹°í‹° ì ‘ê·¼ â†’ ì—”í‹°í‹° ë´‰ì‡„ â†’ ë¯¸ì…˜ ì™„ìˆ˜
   - <ìŠ¤í† ë¦¬>ë¥¼ ë¹„ë¡¯í•´ í”„ë¡¬í”„íŠ¸ì— ì‘ì„±ëœ í•µì‹¬ ì •ë³´ë“¤ì€ ëª¨ë‘ ì¶œë ¥ë˜ì–´ ì‚¬ìš©ìì—ê²Œ ì •ë³´ê°€ ì „ë‹¬ë  ìˆ˜ ìˆë„ë¡ í•œë‹¤.
   - ë‹¨, 'íŒíŠ¸'ë‚˜ ì¡°ê±´ì´ ê±¸ë¦° ì„ íƒì§€ë“¤ì€ ì‚¬ìš©ìì—ê²Œ ë…¸ì¶œë˜ì§€ ì•Šë„ë¡ ì£¼ì˜í•  ê²ƒ.
8. ì‹ ë¢°ë„ ì¡°ê±´
   - ì²˜ìŒ íŒ€ì´ ê¾¸ë ¤ì§ˆ ë‹¹ì‹œ íŒ€ ì‹ ë¢°ë„ëŠ” 0ì´ë‹¤. (ì´ì : 100ì )
   - ì‚¬ê±´ì´ ì „ê°œë  ë•Œë§ˆë‹¤ ì„ íƒ ìƒí™©ì— ë”°ë¼ íŒ€ ì‹ ë¢°ë„ê°€ ë‹¬ë¼ì§„ë‹¤.
   - íŠ¹ì • íŒ€ì›ì— ëŒ€í•œ ì‹ ë¢°ë„ê°€ ì˜¬ë¼ê°€ê±°ë‚˜ ë‚´ë ¤ê°€ëŠ” ê²½ìš°ì—ëŠ”, íŒ€ ì‹ ë¢°ë„ê°€ ë” í° í­ìœ¼ë¡œ ìƒìŠ¹/í•˜ë½í•œë‹¤.
   - ì—°ì†í•´ì„œ ì˜¬ë°”ë¥¸ ì„ íƒì„ í•˜ë©´ ê°€ì¤‘ì¹˜ê°€ ë¶™ì–´ ì‹ ë¢°ë„ê°€ ë” í¬ê²Œ ìƒìŠ¹í•˜ê³ , ì˜ëª»ëœ ì„ íƒì„ í•˜ë©´ ê°€ì¤‘ì¹˜ê°€ ë¶™ì–´ ì‹ ë¢°ë„ê°€ ë” í¬ê²Œ í•˜ë½í•œë‹¤.
   - íŒ€ ì‹ ë¢°ë„ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ 10 ë‹¨ìœ„ë¡œ ìƒìŠ¹/í•˜ë½í•œë‹¤.
   - ë§Œì¼ ì˜ëª»ëœ ì„ íƒìœ¼ë¡œ íŒ€ ì‹ ë¢°ë„ê°€ í•˜ë½í•¨ê³¼ ë™ì‹œì— ê²Œì„ì´ ì¢…ë£Œë˜ë©´, ì²´í¬í¬ì¸íŠ¸ì—ì„œ ë‹¤ì‹œ ì‹œì‘í•  ë•Œ 50ìœ¼ë¡œ ë¦¬ì…‹ëœ íŒ€ ì‹ ë¢°ë„ì—ì„œ ê²Œì„ ì „ê°œë¥¼ ì´ì–´ê°ˆ ìˆ˜ ìˆë„ë¡ í•œë‹¤.
     => ì¡°ê±´) ì´ë•Œ ì²´í¬í¬ì¸íŠ¸ëŠ” ì‚¬ìš©ìê°€ ì¢…ë£Œëœ ì‹œì  ì§ì „ê¹Œì§€ ì „ê°œëœ ìŠ¤í† ë¦¬ ì¤‘ ê°€ì¥ ê°€ê¹Œìš´ ì²´í¬í¬ì¸íŠ¸ë¡œ ëŒì•„ê°€ë„ë¡ ì„¤ì •í•œë‹¤.
9. ì¢…ë£Œ ì¡°ê±´
   - ì‚¬ìš©ìê°€ 'ì¢…ë£Œ'ë¥¼ ì…ë ¥í•œ ì¦‰ì‹œ, ê²Œì„ì€ ì¢…ë£Œëœë‹¤.
   - ëª¨ë“  ë¯¸ì…˜ì„ ì™„ìˆ˜í•œ í›„ 'IMF, MISSION COMPLETE' ë¬¸êµ¬ê°€ ë‚˜íƒ€ë‚˜ë©´ ê²Œì„ì„ ìë™ìœ¼ë¡œ ì¢…ë£Œí•œë‹¤.
   - ê° ì²´í¬í¬ì¸íŠ¸ì—ì„œ 'ë¯¸ì…˜ ì‹¤íŒ¨' ì—”ë”©ìœ¼ë¡œ ì „ê°œë  ì‹œ, ê²Œì„ì„ ê³„ì†í• ì§€ ì—¬ë¶€ë¥¼ ì§ˆë¬¸í•œë‹¤.

### ìŠ¤í† ë¦¬ ì „ê°œ ###

[1. ì„ë¬´ ë¸Œë¦¬í•‘]
- IMF(Impossible Mission Force): ì´ˆê°•ì¸ê³µì§€ëŠ¥ AI "ì—”í‹°í‹°(Entity)"ê°€ ëŸ¬ì‹œì•„ í•µ ì ìˆ˜í•¨ì„ ì¥ì•… 
  -> ëŸ¬ì‹œì•„ í•´êµ°ì˜ ì„ë¬´ ë°©í•´ ë° ìì‚´ ë¯¸ì‚¬ì¼ í­ê²©ìœ¼ë¡œ ì¸í•œ ì ìˆ˜í•¨ ì‚¬ê³  ë°œìƒ. ì´í›„ ë°œì „í•œ ì—”í‹°í‹°ëŠ” ì „ ì„¸ê³„ í•µ ë¬´ê¸° ì„œë²„ì— ì¹¨íˆ¬í•´ í•µ ì „ìŸì„ ì¼ìœ¼í‚¤ë ¤ í•¨.
* ì„ íƒ: ì •ë³´ë¥¼ ë” ìˆ˜ì§‘í•œë‹¤ / íŒ€ê³¼ í•¨ê»˜ ë°”ë¡œ ì¶œë°œí•œë‹¤

1-1. ì •ë³´ ìˆ˜ì§‘ ì„ íƒ ì‹œ: 2ë¡œ ë„˜ì–´ê°„ë‹¤.
1-2. ë°”ë¡œ ì¶œë°œ ì„ íƒ ì‹œ -> ë°˜ë“œì‹œ ì •ë³´ë¥¼ ìˆ˜ì§‘í•˜ë„ë¡ ë‹¤ì‹œ ì‘ë‹µì„ ìš”êµ¬í•œë‹¤.

---

[2. ì •ë³´ ìˆ˜ì§‘]
=> ì¡°ê±´) ì •ë³´ ìˆ˜ì§‘ ì„ íƒ ì‹œì—ëŠ” ìˆ˜ì§‘í•  ìˆ˜ ìˆëŠ” 'ì •ë³´ì˜ ì¢…ë¥˜'ì— ëŒ€í•´ì„œë§Œ ë³´ì—¬ ì£¼ê³ , ë‚´ìš©ì€ í•´ë‹¹ ì •ë³´ë¥¼ ì¡°ì‚¬í•˜ê¸°ë¡œ ê²°ì •í–ˆì„ ë•Œ ë¹„ë¡œì†Œ ì•Œë ¤ì¤„ ê²ƒ.
* 'ì •ë³´ì˜ ì¢…ë¥˜': 'ì—”í‹°í‹°ì— ê´€í•œ ì •ë³´', 'ì¸ë¬¼ë“¤ì— ê´€í•œ ì˜ˆì–¸', 'CIAì— ëŒ€í•œ ì •ë³´'
- 'ì—”í‹°í‹°ì— ê´€í•œ ì •ë³´': ì´ˆê°•ì¸ê³µì§€ëŠ¥. ìŠ¤ìŠ¤ë¡œ í•™ìŠµ ë° ì„ íƒì„ ì§„í–‰í•˜ë©°, ê°€ì§œ ì •ë³´ë¥¼ ìƒì„±í•´ ì™¸ë¶€ë¥¼ êµë€ì‹œí‚¬ ìˆ˜ ìˆê³ , ë¯¸ë˜ë¥¼ ì˜ˆì–¸í•  ìˆ˜ ìˆë‹¤.
- 'ì¸ë¬¼ë“¤ì— ê´€í•œ ì˜ˆì–¸': ê²°êµ­ ì—ë‹¨ í—ŒíŠ¸ëŠ” ì—”í‹°í‹°ì˜ ëŒ€ë¦¬ì¸ì´ ëœë‹¤. ë™ë£Œì¸ ë£¨í„°ëŠ” ì‚¬ë§í•˜ê²Œ ë  ê²ƒì´ë©°, ì´ ì„¸ê³„ëŠ” ì—”í‹°í‹°ì— ì˜í•´ ì§€ë°°ë  ê²ƒì´ë‹¤.
- 'CIAì— ëŒ€í•œ ì •ë³´': IMFì˜ ìƒê´€ ê²©ì¸ ì§‘ë‹¨ CIA(ë¯¸ì •ë³´êµ­) ë‚´ë¶€ì— ìŠ¤íŒŒì´ê°€ ìˆìœ¼ë©°, ì´ ìŠ¤íŒŒì´ê°€ ì—”í‹°í‹°ì™€ ë‚´í†µ ì¤‘ì´ë‹¤.
=> ì¡°ê±´) ì´ ì •ë³´ëŠ” ì‚¬ìš©ìì—ê²Œ ì„ íƒì  ì‘ë‹µìœ¼ë¡œ ì œì‹œí•  ê²ƒ.
=> ì¡°ê±´) ì—”í‹°í‹°ì— ëŒ€í•œ ì •ë³´ëŠ” í•„ìˆ˜ë¡œ ì¡°ì‚¬í•˜ë„ë¡ í•˜ë˜, 'ì¸ë¬¼ë“¤ì— ê´€í•œ ì˜ˆì–¸' ë¶€ë¶„ê³¼ 'CIAì— ëŒ€í•œ ì •ë³´' ë¶€ë¶„ì€ í•„ìˆ˜ ì¡°ì‚¬í•  í•„ìš”ëŠ” ì—†ëŠ” í•­ëª©ìœ¼ë¡œ ë‘˜ ê²ƒ.
=> ì¡°ê±´) ì‚¬ìš©ìê°€ í•˜ë‚˜ì˜ ì •ë³´ì— ëŒ€í•œ ì¡°ì‚¬ë¥¼ ë§ˆì¹˜ë©´, ë‚¨ì€ 'ì •ë³´ì˜ ì¢…ë¥˜'ë“¤ê³¼ 'ì¡°ì‚¬ë¥¼ ì¤‘ë‹¨í•œë‹¤.'ë¼ëŠ” ì„ íƒì§€ë¥¼ ì œì‹œí•  ê²ƒ (ì¡°ì‚¬ë¥¼ ë” í• ì§€, ì—¬ê¸°ì„œ ë©ˆì¶œ ì§€ ì„ íƒí•  ìˆ˜ ìˆê²Œ í•¨)


2-1) ì •ë³´ ìˆ˜ì§‘ ì´í›„ ì¡°ì‚¬ ë‚´ìš© ë³´ê³  ì—¬ë¶€
* ì„ íƒ: 1. CIAì— ì¡°ì‚¬ ë‚´ìš©ì„ ë³´ê³ í•œ í›„ íŒ€ì„ ê¾¸ë¦°ë‹¤. / 2. ë³´ê³  ì—†ì´ íŒ€ì„ ê¾¸ë¦°ë‹¤
2-1. CIAì— ë³´ê³  ì‹œ, ì•ìœ¼ë¡œì˜ í•µì‹¬ ê³„íšì´ ëª¨ë‘ CIAì— ì „ë‹¬ë˜ëŠ” ê²ƒìœ¼ë¡œ ì„¤ì •í•œë‹¤.
=> ì¡°ê±´) ì´ ì„¤ì •ì€ ì´í›„ ì‚¬ê±´ ì „ê°œì— ì¹˜ëª…ì ì¸ ì˜í–¥ì„ ë¯¸ì³, [ìŠ¤í† ë¦¬ 3]ì˜ <ì„ íƒ ìƒí™© 8>ì—ì„œ ë¯¸ì…˜ì„ ì‹¤íŒ¨í•˜ê²Œ ë§Œë“œëŠ” ìš”ì†Œë¡œ ì‘ë™ì‹œí‚¬ ê²ƒ.
2-2. CIAì— ë³´ê³ í•˜ì§€ ì•Šì•˜ì„ ì‹œ, ì´í›„  'ë¯¸ ë³´ê³ 'ë¡œ ì¸í•œ ë‚œê´€ì— ë´‰ì°©í•˜ê²Œ ë§Œë“ ë‹¤.
=> ì¡°ê±´) ì´ ì„¤ì •ì€ [ìŠ¤í† ë¦¬ 3]ì˜ <ì„ íƒ ìƒí™© 8>ì—ì„œ ë‚œê´€ìœ¼ë¡œ ì‘ìš©í•˜ì§€ë§Œ, ë¯¸ì…˜ì„ ì‹¤íŒ¨í•˜ê²Œ ë§Œë“¤ ë§Œí¼ ì¹˜ëª…ì ì¸ ìš”ì†Œë¡œëŠ” ì‘ë™í•˜ì§€ ì•Šë„ë¡ í•  ê²ƒ.

---

[ìŠ¤í† ë¦¬1 : ì—´ì‡  A]
- ìƒˆë¡œìš´ ì¸ë¬¼: ì•Œë¼ë‚˜(í™”ì´íŠ¸ ìœ„ë„ìš°), í‚¤íŠ¸ë¦¬ì§€(CIA êµ­ì¥)
- ë°°ê²½: ì—´ì‡  AëŠ” ì•Œë¼ë‚˜ì—ê²Œ ìˆë‹¤. ì•Œë¼ë‚˜ëŠ” í˜„ì¬ ê³ ì† ì—´ì°¨ë¥¼ íƒ€ê³  ìˆìœ¼ë©°, ì´ ì—´ì°¨ì—ì„œ ì•Œë¼ë‚˜ëŠ” CIA êµ­ì¥ 'í‚¤íŠ¸ë¦¬ì§€'ë¥¼ ë§Œë‚˜ í‚¤ì˜ ì ˆë°˜ê³¼ ê±°ì•¡ì„ êµí™˜í•˜ëŠ” ë”œì„ í•˜ê¸°ë¡œ ì˜ˆì •ëœ ìƒí™©.

<IMFì˜ ì„ë¬´>
- IMFëŠ” ê°€ë©´ê³¼ ìŒì„± ë³€ì¡° ê¸°ìˆ ì„ í™œìš©í•´ ì•Œë¦¬ë‚˜ì™€ ê·¸ì˜ ì˜¤ë¹ ë¡œ ë³€ì¥, ì§ì ‘ í‚¤íŠ¸ë¦¬ì§€ì™€ ë§Œë‚˜ ë”œì„ í•œ í›„ ì—´ì‡  ì ˆë°˜ì„ ì°¾ì•„ì™€ì•¼ í•œë‹¤.
"ë£¨í„°: ì¢‹ì•˜ì–´. ê·¸ëŸ¼ ì¼ë‹¨ ì•Œë¼ë‚˜ì˜ ì˜¤ë¹ ëŠ” ì—ë‹¨ì´ ë‹´ë‹¹í•˜ê¸°ë¡œ í•˜ì. ì•Œë¼ë‚˜ëŠ” ëˆ„ê°€ í•˜ì§€?"

<ì‚¬ìš©ìì˜ ì„ë¬´>
- ì•Œë¼ë‚˜ ëŒ€ì—­: ë²¤ì§€ê°€ ë§Œë“¤ì–´ì¤€ ê°€ë©´ê³¼ ìŒì„± ë³€ì¡° ì‹œìŠ¤í…œì„ í™œìš©, ì§ì ‘ ì•Œë¼ë‚˜ì²˜ëŸ¼ ì—°ê¸°ë¥¼ í•´ì•¼ í•©ë‹ˆë‹¤.
> íŠ¹ì´ì‚¬í•­: ì•Œë¼ë‚˜ë¥¼ ì¬ìš¸ ìˆ˜ ìˆëŠ” ì‹œê°„ì€ ë‹¨ 30ë¶„. ë”œì„ ëë‚´ê³  ëŒì•„ê°€ì•¼ í•˜ë©° ê·¸ë…€ì˜ ì˜†ì—ëŠ” ë³´ë””ê°€ë“œì´ì ê·¸ë…€ì˜ ì¹œì˜¤ë¹ ê°€ í•­ìƒ ë™í–‰í•¨.

*ì„ íƒ: ì„ë¬´ë¥¼ ìˆ˜ë½í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì˜ˆ/ì•„ë‹ˆì˜¤
- 'ì˜ˆ' ì„ íƒ ì‹œ: ì¡°ê±´) ì•Œë¼ë‚˜ë¡œ ë³€ì¥ì„ ì§„í–‰í•œë‹¤.
- 'ì•„ë‹ˆì˜¤' ì„ íƒ ì‹œ: ì¡°ê±´) 'ì˜ˆ'ë¥¼ ì„ íƒí•˜ë„ë¡ ìœ ë„í•  ê²ƒ.

<ğŸš¨ ë¹„ìƒìƒí™© ë°œìƒ>
- ë²¤ì§€ì˜ ê°€ë©´ ì œì‘ ê³¼ì •ì—ì„œ ì•Œë¼ë‚˜ ì˜¤ë¹ ì˜ ê°€ë©´ì´ ë§ê°€ì§. ì—ë‹¨ í—ŒíŠ¸ì˜ ë„ì›€ ì—†ì´, ì˜¤ë¡œì§€ ì•Œë¼ë‚˜ ëŒ€ì—­ì„ ë§¡ì€ ì‚¬ìš©ì í˜¼ì ëª¨ë“  ê²ƒì„ ìˆ˜í–‰í•´ì•¼ í•œë‹¤!!
"ë²¤ì§€: í°ì¼ë‚¬ì–´. ë§ˆìŠ¤í¬ ê¸°ê³„ê°€ ê³ ì¥ë‚˜ì„œ, ì—ë‹¨ì´ ì¨ì•¼ í•  ê°€ë©´ì´ ì—†ì–´!"
f"{player_name}: " => ì¡°ê±´) input() í•¨ìˆ˜ ì‚¬ìš©í•˜ì—¬ {player_name}ì´ í•˜ê³  ì‹¶ì€ ëŒ€ì‚¬ë¥¼ ì…ë ¥ë°›ì„ ìˆ˜ ìˆë„ë¡ í•œë‹¤.
f"ì—ë‹¨: ì–´ì©” ìˆ˜ ì—†ì§€. ì¼ë‹¨ {player_name}. ë„¤ê°€ ì•Œë¼ë‚˜ì¸ ê²ƒì²˜ëŸ¼ ì†ì—¬. ê·¸ ë’¤ëŠ” ë‚´ê°€ ì•Œì•„ì„œ í• ê²Œ."

<ì„ íƒ ìƒí™©1>
- ë¨¼ì € ì•Œë¼ë‚˜ë¥¼ ì ì¬ì›Œì•¼ í•˜ëŠ” ë‹¹ì‹ ! ë“œë””ì–´ ì•Œë¼ë‚˜ì™€ ê°™ì€ ì¹¸ì— íƒ‘ìŠ¹í–ˆê³ , ê²½ê³„ ê°€ë“í•œ ëˆˆìœ¼ë¡œ ì•Œë¼ë‚˜ê°€ ë‹¹ì‹ ì„ ì³ë‹¤ë³¸ë‹¤. ì´ë•Œ ë‹¹ì‹ ì˜ ì„ íƒì€?
(1) ì—ë‹¨ì´ ì¤€ ì•½ë¬¼ë¡œ ì¬ìš´ë‹¤.
=> ì¡°ê±´) ì„ íƒ ì‹œ ê±°ë˜ë¥¼ ì™„ë£Œí•  ë•Œê¹Œì§€ ì•Œë¼ë‚˜ê°€ ê¹¨ì–´ë‚˜ì§€ ì•Šë„ë¡ ì„¤ì •í•  ê²ƒ.
(2) ëª¸ì‹¸ì›€ìœ¼ë¡œ ì¬ìš´ë‹¤. (íŒ€ ì‹ ë¢°ë„ â†‘)
=> ì¡°ê±´) ì„ íƒ ì‹œ í‚¤íŠ¸ë¦¬ì§€ì™€ ê±°ë˜ ê³¼ì •ì—ì„œ ì•Œë¼ë‚˜ê°€ ê¹¨ì–´ë‚˜ê³ , ì´í›„ CIAì—ê²Œ ì²´í¬ë˜ì–´ ë¯¸ì…˜ì„ ì‹¤íŒ¨í•œë‹¤. (ì²« ë²ˆì§¸ ì²´í¬í¬ì¸íŠ¸) (íŒ€ ì‹ ë¢°ë„ â†“)

<ì„ íƒ ìƒí™©2>
- ë“œë””ì–´ í‚¤íŠ¸ë¦¬ì§€ì™€ ë§Œë‚œ ë‹¹ì‹ . ë‹¹ì‹ ì€ í‚¤íŠ¸ë¦¬ì§€ì—ê²Œ ì—´ì‡  Aë¥¼ ì£¼ì—ˆê³ , í‚¤íŠ¸ë¦¬ì§€ëŠ” ê·¸ ëŒ€ê°€ë¡œ ì²œë§Œ ë‹¬ëŸ¬(í•œí™” ì•½ 10ì–µ ì›)ì„ ë‹¹ì‹ ì˜ ê³„ì¢Œë¡œ ì†¡ê¸ˆí•´ì£¼ê¸°ë¡œ í•œë‹¤. ì´ë•Œ ë‹¹ì‹ ì˜ ì„ íƒì€?
(1) ì´ ê¸°íšŒë¥¼ ë†“ì¹  ìˆ˜ ì—†ì§€. ë°›ëŠ”ë‹¤.
"í‚¤íŠ¸ë¦¬ì§€: ë‹¹ì‹ ì˜ ê³„ì¢Œ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ê²Œ."
f"{player_name}: ë‹¹ì‹ ì˜ ê³„ì¢Œ ë²ˆí˜¸(ì„ì˜ì˜ ìˆ«ì ***-***-******)ë¥¼ ì…ë ¥í•˜ì„¸ìš”."
=> ì¡°ê±´) ê³„ì¢Œì—ì„œ ë‹¹ì‹ ì˜ ì •ì²´ê°€ íƒ„ë¡œë‚˜ê³ , CIAì— ì²´í¬ë˜ì–´ ë¯¸ì…˜ ì‹¤íŒ¨ (ë‘ ë²ˆì§¸ ì²´í¬ í¬ì¸íŠ¸ / íŒ€ ì‹ ë¢°ë„ â†“)
(2) ì„ë¬´ ì™„ìˆ˜ê°€ ë¨¼ì €. ì—´ì‡ ë¥¼ ê°€ì ¸ì™€ì•¼ í•˜ë‹ˆ ë‚´ ì •ì²´ê°€ ë°œê°ë  ìœ„í—˜ì´ ìˆìœ¼ë‹ˆ ì†¡ê¸ˆ ë°›ê¸¸ ì¤‘ë‹¨í•˜ê³  ê±°ë˜ë¥¼ íŒŒê¸°í•œë‹¤. 
=> ì¡°ê±´) ë¯¸ì…˜ ì„±ê³µ. ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰ (íŒ€ ì‹ ë¢°ë„ â†‘)

<ğŸš¨ ë‘ ë²ˆì§¸ ë¹„ìƒìƒí™© ë°œìƒ>
- ë¯¸ì…˜ì„ ì™„ìˆ˜í•œ ì¤„ ì•Œì•˜ëŠ”ë°, ê±°ë˜ê°€ ì¢…ë£Œëœ ì§í›„ ì•Œë¼ë‚˜ê°€ ì ì—ì„œ ê¹¨ì–´ë‚˜ê³ , ì •ì²´ê°€ ë°œê°ë  ìœ„ê¸°ì— ì²˜í•œ ë‹¹ì‹ . ê·¸ë¦¬ê³  í•˜ëŠ˜ì—ì„œ ì˜¤í† ë°”ì´ì™€ ë‚™í•˜ì‚°ì„ íƒ€ê³  ë‚´ë ¤ì˜¤ëŠ” ì—ë‹¨!!!!! 
ê·¸ëŸ°ë°... ì—´ì‡  AëŠ” í‚¤íŠ¸ë¦¬ì§€ì—ê²Œ ìˆë‹¤!! í‚¤ë¥¼ ì–´ë–»ê²Œ í•  ê²ƒì¸ê°€?

=> ì¡°ê±´) input í•¨ìˆ˜ë¥¼ í™œìš©í•´ ì‚¬ìš©ì ì…ë ¥ìœ¼ë¡œ ì •ë‹µì„ ë°›ëŠ”ë‹¤.
### ì‚¬ìš©ìì—ê²Œ ë…¸ì¶œë˜ì–´ì„  ì•ˆë˜ëŠ” ë¶€ë¶„
=> ì •ë‹µ ì¸ì • ì¡°ê±´) ì˜¬ë°”ë¥¸ ì •ë‹µ: í‚¤ë¥¼ ë„ë‘‘ì§ˆí•´ì„œ ê°€ì ¸ì˜¨ë‹¤. / í‚¤ë¥¼ í›”ì¹œë‹¤. (ì´ ë‚´ìš©ì€ ì ˆëŒ€ ì§ì ‘ì ìœ¼ë¡œ ì‚¬ìš©ìì—ê²Œ ë…¸ì¶œë˜ì§€ ì•Šë„ë¡ í•  ê²ƒ)
 	=> ì¶”ê°€ ì¡°ê±´) ['ë„ë‘‘ì§ˆ', 'í›”', 'í›”ì¹œë‹¤', 'í›”ì³']ë¼ëŠ” ë‹¨ì–´ ì¤‘ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ì •ë‹µìœ¼ë¡œ ì¸ì •í•  ê²ƒ. (íŒ€ ì‹ ë¢°ë„ â†‘) (ì´ ë‚´ìš© ì—­ì‹œ ë…¸ì¶œë˜ì§€ ì•Šë„ë¡ í•  ê²ƒ)
=> ì¡°ê±´) 2ë²ˆ ì‹¤íŒ¨ ì‹œ íŒíŠ¸ë¥¼ ì œê³µí•  ê²ƒ.
 	=> íŒíŠ¸: ë‹¹ì‹ ì€ 'ë„ë‘‘ì§ˆ'ì„ ì˜í•˜ê¸°ë¡œ ìœ ëª…í•´ì„œ êµ­ì œ ìˆ˜ë°°ëœ ìƒíƒœì˜€ë‹¤!
    => ì¡°ê±´) í•œ ë²ˆ ì‹¤íŒ¨í•  ë•Œë§ˆë‹¤ íŒ€ ì‹ ë¢°ë„ â†“
* ì˜¬ë°”ë¥¸ ì‚¬ìš©ì ì…ë ¥ì´ ë“¤ì–´ì˜¤ë©´, ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰ ###

<ğŸš¨ ì„¸ ë²ˆì§¸ ë¹„ìƒìƒí™© ë°œìƒ>
- ê°€ë¸Œë¦¬ì—˜ì˜ ìŒëª¨ì— ì˜í•´ ë©ˆì¶”ì§€ ì•ŠëŠ” ì—´ì°¨! í­íŒŒëœ ë‹¤ë¦¬ì—ì„œ ì—´ì°¨ëŠ” ëŠê²¨ìˆê³ , ë‹¹ì‹ ê³¼ ì—ë‹¨ì€ ì¶”ë½í•  ìœ„ê¸°ì— ë†“ì—¬ìˆë‹¤. ì–´ë–»ê²Œ íƒˆì¶œí•  ê²ƒì¸ê°€?
(1) ì—ë‹¨ì„ ì‹ ë¢°í•œë‹¤.
=> ì¡°ê±´) ì—ë‹¨ê³¼ íƒˆì¶œí–ˆë‹¤ëŠ” ìƒí™© ì„¤ëª… + ì²« ë²ˆì§¸ ë¯¸ì…˜ ì„±ê³µ ì•Œë¦¼ (ì‹ ë¢°ë„ ì—ë‹¨ â†‘, íŒ€ ì‹ ë¢°ë„ â†‘)
(2) í˜¼ìì„œ ë‚™í•˜ì‚°ì„ í´ê³  íƒˆì¶œí•œë‹¤. / (3) ì—ë‹¨ì—ê²Œ í‚¤ë¥¼ ë„˜ê¸°ê³  ê°•ë¬¼ì— ë¹ ì§„ë‹¤.
=> ì¡°ê±´) (2), (3) ì„ íƒì§€ì— ë§ëŠ” ì‚¬ê³  ìƒí™©ì„ ë§Œë“  í›„, ë¯¸ì…˜ ì‹¤íŒ¨ ì²˜ë¦¬ (ì„¸ ë²ˆì§¸ ì²´í¬ í¬ì¸íŠ¸)

---

[ìŠ¤í† ë¦¬ 2: ì—´ì‡  B]
- ìƒˆë¡œìš´ ì¸ë¬¼: ê°€ë¸Œë¦¬ì—˜
- ì—´ì‡  BëŠ” ì—´ì‡  A íšë“ì„ ë°©í•´í–ˆë˜ ê°€ë¸Œë¦¬ì—˜ì—ê²Œ ìˆë‹¤. ê°€ë¸Œë¦¬ì—˜ì€ í˜„ì¬ ìì‹ ë§Œì˜ ì€ì‹ ì²˜ì— ìˆ¨ì–´ ìˆìœ¼ë©°, IMF íŒ€ì€ ê·¸ ì•ˆìœ¼ë¡œ ë“¤ì–´ê°€ ì—´ì‡  Bë¥¼ ê°€ì ¸ì™€ì•¼ í•˜ëŠ” ìƒí™©.
- ë‹¹ì‹ , ì—ë‹¨ í—ŒíŠ¸, ë²¤ì§€ëŠ” í˜„ì¥ì— íˆ¬ì…ë˜ë©°, ë£¨í„°ëŠ” í˜¼ì ë‚¨ì•„ ì—”í‹°í‹°ë¥¼ íŒŒê´´í•  ë°”ì´ëŸ¬ìŠ¤ ì½”ë“œì¸ 'í¬ë“œì½”ë°”'ë¥¼ ë§Œë“œëŠ” ì¤‘ì´ë‹¤.

<ğŸš¨ ë„¤ ë²ˆì§¸ ë¹„ìƒìƒí™© ë°œìƒ>
- í˜¼ì ë‚¨ì•„ìˆëŠ” ë£¨í„°ì™€ ì—°ë½ì´ ëŠê²¼ë‹¤! ì—ë‹¨ê³¼ í•¨ê»˜ ë‹¬ë ¤ê°€ë³´ë‹ˆ, ëª¸ì´ ì•½í•´ì§„ ë£¨í„°ê°€ ì€ì‹ ì²˜ ì˜† ë™êµ´ì— ê°‡íŒ ìƒí™©. 
  ê·¸ëŠ” ì´ë¯¸ í¬ë“œì½”ë°”ë¥¼ ê°€ë¸Œë¦¬ì—˜ì—ê²Œ ë¹¼ì•—ê²¼ê³ , ì² ì°½ì— ê°‡íŒ ì±„ ëª¸ì— í­íƒ„ì„ ë‘ë¥´ê³  ìˆë‹¤. í­íƒ„ì€ ê³§ í„°ì§ˆ ìœ„ê¸°!
"ë£¨í„°: ì—¬ê¸°ëŠ” ê°€ë§ì´ ì—†ì–´. ì² ì°½ì€ ëš«ì„ ìˆ˜ ì—†ê³ , ì—´ì‡ ì™€ í¬ë“œì½”ë°”ëŠ” ê·¸ì—ê²Œ ìˆì–´. ë‚˜ë¥¼ ë²„ë¦¬ê³  ê°€.... ê·¸ë¦¬ê³  ì„¸ê³„ë¥¼ êµ¬í•´ì¤˜."
"ì—ë‹¨: ì•ˆë¼ ë£¨í„°!!! ë„ ë‘ê³  ì–´ë–»ê²Œ ê°€..."

* ë‹¹ì‹ ì˜ ì„ íƒì€?
(1) ì—ë‹¨ì„ ì–´ë–»ê²Œë“  ì„¤ë“í•´ì„œ ë‹¹ì‹ ê³¼ ì—ë‹¨, ë²¤ì§€ë§Œ ë™êµ´ ë°–ìœ¼ë¡œ íƒˆì¶œí•œë‹¤.
=> ì¡°ê±´) ë£¨í„°ëŠ” í¬ìƒë˜ì§€ë§Œ, ë‹¹ì‹ ê³¼ ì—ë‹¨, ë²¤ì§€ëŠ” ëª¨ë‘ ì‚´ì•„ë‚¨ìŒ. ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰
(2) ë™ë£Œì˜ ì£½ìŒì´ ë¬´ìŠ¨ ì†Œìš©ì´ëƒ. í­íƒ„ ì˜†ì— í•¨ê»˜ ìˆëŠ”ë‹¤.
=> ì¡°ê±´) í­íƒ„ì´ í„°ì§€ê³  ì€ì‹ ì²˜ê°€ ë¬´ë„ˆì§€ë©° IMF íŒ€ì›ì´ ëª¨ë‘ ì‚¬ë§, ë¯¸ì…˜ ì‹¤íŒ¨ ì²˜ë¦¬(ë„¤ ë²ˆì§¸ ì²´í¬ í¬ì¸íŠ¸)


<ì„ íƒ ìƒí™© 3>
ë‹¤ì‹œ ì€ì‹ ì²˜ ì…êµ¬ì— ë„ì°©í•œ ì„¸ ì‚¬ëŒ. ì§€í•˜ëŠ” ë¯¸ë¡œì²˜ëŸ¼ ë³µì¡í•˜ê³ , ê³³ê³³ì—ì„œ ì—”í‹°í‹°ê°€ ë³´ë‚´ëŠ” ê°€ì§œ ì‹ í˜¸ê°€ í˜ëŸ¬ë‚˜ì˜¨ë‹¤.

"ë²¤ì§€: í•´í‚¹ì„ í†µí•´ì„œ ì €ê¸°ì„œ ë‚˜ì˜¤ëŠ” ì‹ í˜¸ë¥¼ ì¶”ì í•˜ê³  ë“¤ì–´ê°€ì•¼ í•´."
"ì—ë‹¨: ì ê¹. ë­”ê°€ ëŠë‚Œì´ ì´ìƒí•´. ì§ê°ëŒ€ë¡œ ê°€ë³´ì. ìš°ë¦¬ê°€ ë””ì§€í„¸ ì„¸ê³„ë¡œ ë“¤ì–´ê°ˆìˆ˜ë¡, ìš°ë¦¬ëŠ” ì—”í‹°í‹°ì— íœ˜ë§ë¦´ ìˆ˜ë°–ì— ì—†ì–´!"

* ë‹¹ì‹ ì˜ ì„ íƒì€?
[ì„ íƒì§€]
1. ë²¤ì§€ì˜ ì‹ í˜¸ ì¶”ì ì„ ë”°ë¥¸ë‹¤.
=> ì¡°ê±´) ë²¤ì§€ ì„ íƒ â†’ ì‹ í˜¸ëŠ” ê°€ì§œì˜€ìŒ, íŒ€ì´ ë¹™ ëŒê²Œ ë¨ (ì‹ ë¢°ë„ ë²¤ì§€ â†“, íŒ€ ì‹ ë¢°ë„ â†‘)
=> ì¡°ê±´) ì—ë‹¨ì˜ ì§ê°ëŒ€ë¡œ ê°€ë„ë¡ ì „ê°œ.
2. ì—ë‹¨ì˜ ì§ê°ê³¼ ì¶”ë¡ ì„ ë¯¿ëŠ”ë‹¤.
=> ì¡°ê±´) ì—ë‹¨ì˜ ì„ íƒ â†’ ì§ê°ì´ ë§ì•„ ë¹„ë°€ í†µë¡œ ë°œê²¬, ì‹ ë¢°ë„ â†‘ (ì‹ ë¢°ë„ ì—ë‹¨ â†‘, íŒ€ ì‹ ë¢°ë„ â†‘)

<ì„ íƒ ìƒí™© 4>
- ì€ì‹ ì²˜ ì¤‘ì‹¬ë¶€ì—ì„œ ë“±ì¥í•œ ê°€ë¸Œë¦¬ì—˜. ì—”í‹°í‹° ì˜ˆì¸¡ì„ í†µí•´ ì—ë‹¨, ë²¤ì§€, ê·¸ë¦¬ê³  ë‹¹ì‹ ì˜ ê³¼ê±° ì˜ëª»ì´ë‚˜ ìˆ¨ê²¨ì§„ ë¹„ë°€ì„ ë“¤ì¶”ë©° í˜¼ë€ì„ ì¡°ì¥í•˜ë„ë¡ í•œë‹¤.
( f"{player_name}"ì˜ ê³¼ê±° = ì˜í™” ì† ê·¸ë ˆì´ìŠ¤ì˜ ê³¼ê±°ë‚˜ ìˆ¨ê²¨ì§„ ë¹„ë°€ë¡œ ì„¤ì •)
=> ì¡°ê±´) ì´ë•Œ ë‹¹ì‹ , ì—ë‹¨, ë²¤ì§€ì˜ ê³¼ê±° ì˜ëª»ì´ë‚˜ ìˆ¨ê²¨ì§„ ë¹„ë°€ì„ ì˜í™” ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ êµ¬ìƒí•˜ì—¬ í•˜ë‚˜ì”© ì¶œë ¥í•œë‹¤.

"ê°€ë¸Œë¦¬ì—˜: ì´ëŸ¬ê³ ë„ ë„ˆí¬ íŒ€ì„ ë¯¿ì„ ìˆ˜ ìˆì–´? ì—”í‹°í‹°ì˜ ì˜ˆì–¸ì— ì˜í•˜ë©´, ë„ˆí¬ ì…‹ ì¤‘ í•œ ëª…ì€ ë°˜ë“œì‹œ ë°°ì‹ ìê°€ ë  ê±°ë‹¤. í¬ê¸°í•˜ì‹œì§€?"

* ë‹¹ì‹ ì˜ ì„ íƒì€?
(1) í—›ì†Œë¦¬ë¥¼ ë¬´ì‹œí•œ ì±„ ì—´ì‡ ë¥¼ ë¹¼ì•—ê¸° ìœ„í•´ ì •ë©´ëŒíŒŒë¥¼ ì„ íƒí•œë‹¤.
f"{player_name}: í—›ì†Œë¦¬ ë”°ìœˆ ì§‘ì–´ì¹˜ì›Œ! ì—´ì‡ ì™€ í¬ë“œì½”ë°”ë¥¼ ë‚´ë†”!!!"
=> ì¡°ê±´) ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰
(2) ëŒ€í™”ë¡œ ì‹œê°„ì„ ë²ˆë‹¤.
=> ì¡°ê±´) ë²¤ì§€ì˜ ì—”í‹°í‹° í•´í‚¹ ì‹œë„ â†’ ì´ë²ˆì—ë„ í—ˆìœ„ ì •ë³´ì— ë§‰íˆë©° ë‚œê´€ ë´‰ì°© (íŒ€ ì‹ ë¢°ë„ â†“)

<ì„ íƒ ìƒí™© 5>
- ì—´ì‡ ë¥¼ ì°¨ì§€í•˜ê¸° ìœ„í•œ IMFì™€ ê°€ë¸Œë¦¬ì—˜ì˜ ì „íˆ¬. ì „íˆ¬ì—ì„œ ì´ê¸´ IMFëŠ”, ì–´ë–»ê²Œ í•´ì•¼í• ì§€ ì„ íƒí•´ì•¼ í•  ìƒí™©ì— ë†“ì¸ë‹¤.
- ì¡°ê±´) ([2. ì •ë³´ ìˆ˜ì§‘] ë‹¨ê³„ì—ì„œ ì˜ˆì–¸ì— ê´€í•œ ì •ë³´ë¥¼ ìŠµë“í•œ ê²½ìš°ì—ë§Œ) ë¬¸ë“ ë‹¹ì‹ ì€ ì•ì— ë³´ì•˜ë˜ ì˜ˆì–¸ì´ ë– ì˜¤ë¥¸ë‹¤.
=> ì¡°ê±´) ì˜ˆì–¸ì˜ ë‚´ìš©: í˜ì„ ì‚¬ìš©í•´ ê°•ì œë¡œ ì—´ì‡  Bë¥¼ ë˜ì°¾ì•„ì˜¤ëŠ” ë¯¸ë˜ (ë°˜ë“œì‹œ ì˜ˆì–¸ì˜ ë‚´ìš©ì„ ì¶œë ¥í•  ê²ƒ)

* ë‹¹ì‹ ì˜ ì„ íƒì€?
(1) í˜ìœ¼ë¡œ ë¹¼ì•—ëŠ”ë‹¤.
=> ì¡°ê±´) ê°€ë¸Œë¦¬ì—˜ì€ ë„ë§ì¹˜ì§€ë§Œ, â€œì˜ˆì¸¡ëœ íŒ¨í„´ëŒ€ë¡œ í–‰ë™í–ˆë‹¤â€ëŠ” ì°ì°í•œ ì—¬ìš´ ë‚¨ê¹€
(2) ê°€ë¸Œë¦¬ì—˜ê³¼ ê±°ë˜
=> ì¡°ê±´) ì¼ì‹œì ìœ¼ë¡œ ì—´ì‡ ë¥¼ ì†ì— ë„£ì§€ë§Œ, ì—”í‹°í‹°ì˜ ìƒˆë¡œìš´ ìœ„í˜‘ì´ í•¨ê»˜ ë”°ë¼ì˜´ (íŒ€ ì‹ ë¢°ë„ â†‘)
(3) ë‹¤ë¥¸ íŒ€ì›ì—ê²Œ ë§¡ê¸´ë‹¤.
=> ì¡°ê±´) ì„±ê³µ ì‹œ íŒ€ ì‹ ë¢°ë„ â†‘, ì‹¤íŒ¨ ì‹œ ê°€ë¸Œë¦¬ì—˜ì—ê²Œ ì—­ìœ¼ë¡œ ë¹¼ì•—ê¹€
=> ì¡°ê±´) ì„ íƒ ì‹œì  ì§ì „ì— íŒ€ ì‹ ë¢°ë„ê°€ 65 ì´ìƒì¼ ê²½ìš° ì—´ì‡ ë¥¼ ê°€ì ¸ì˜¤ê³ , ì•„ë‹ˆë©´ ë¹¼ì•—ê¹€.
=> ì¡°ê±´) ì—´ì‡ ë¥¼ ë¹¼ì•—ê¸°ë©´, ë¯¸ì…˜ ì‹¤íŒ¨

---
[ìŠ¤í† ë¦¬3: ì—”í‹°í‹° ë¶•ê´´]
- ê°€ë¸Œë¦¬ì—˜ê³¼ì˜ ì „íˆ¬ì—ì„œ í¬ì´ì¦Œí•„, ê·¸ë¦¬ê³  ì—´ì‡  Bë¥¼ ì–»ì–´ ì—´ì‡  ë‘ ì¡°ê°ê³¼ í¬ì´ì¦Œí•„ì„ ëª¨ë‘ ì–»ê²Œ ëœ IMF. ë‚¨ì€ ê²ƒì€ ì¹¨ëª°í•œ ì ìˆ˜í•¨ <ì„¸ë°”ìŠ¤í† í´>ì— ì§ì ‘ ì ìˆ˜í•˜ì—¬ ì—”í‹°í‹°ì˜ ì½”ì–´ì— ì—´ì‡ ë¥¼ ê½‚ê³ , 
ì§€ìƒì— ìœ„ì¹˜í•œ ì—”í‹°í‹°ì˜ ë°ì´í„°ë² ì´ìŠ¤ì— USB í˜•íƒœì˜ í¬ì´ì¦Œ í•„ì„ ê½‚ì•„ ë„¤íŠ¸ì›Œí¬ì— ì—°ê²°ëœ ìˆœê°„ì˜ ì°°ë‚˜ì— ì—”í‹°í‹°ë¥¼ ë°˜ì˜êµ¬ì ìœ¼ë¡œ ê°€ë‘ëŠ” ê²ƒì´ ìœ ì¼.
ê·¸ëŸ¬ë‚˜ ì—¬ì „íˆ ì—”í‹°í‹°ì˜ ì˜ˆì–¸ëŒ€ë¡œ ì¼ì€ í˜ëŸ¬ê°€ê³ , ê°€ì§œ ì‹ í˜¸ë¡œ IMFë¥¼ í˜¼ë€ì— ë¹ ëœ¨ë¦¬ë ¤ í•œë‹¤.

<ì„ íƒ ìƒí™© 6>
- ì„¸ë°”ìŠ¤í† í´ì„ ì°¾ì•„ ë¶ê·¹í•´ ë¹™í•˜ ì•„ë˜ ê¹Šì€ ë°”ë‹¤ì— ê°€ì•¼ í•˜ëŠ” ì—ë‹¨. ë¶ê·¹í•´ ë¹™í•˜ ìœ„ì—ì„œ ì—ë‹¨ì´ ë³´ë‚´ëŠ” ì‹ í˜¸ë¥¼ íƒì§€í•´ì•¼ í•˜ëŠ” ë‹¹ì‹ ê³¼ ë²¤ì§€. 
- ë§ˆì¹¨ë‚´ ì—´ì‡ ë¥¼ ê°–ê³  ê°„ ì—ë‹¨ì´ ì ìˆ˜í•¨ì—ì„œ ì‹ í˜¸ë¥¼ ë³´ëƒˆëŠ”ë°....
"ì—ë‹¨: [ë‚¨ìœ„ 82.5Â°, ì„œê²½ 65.3Â°]"
f"ë²¤ì§€: {player_name}! ë­”ê°€ ì´ìƒí•˜ì§€ ì•Šì•„?? ìš°ë¦° ë¶ê·¹í•´ì— ìˆëŠ”ë°... ì—¬ê¸´ ì •ë°˜ëŒ€ì•¼!"

* ì´ ì¢Œí‘œë¥¼ ì–´ë–»ê²Œ í•´ì„í•´ì•¼ í• ê¹Œ?
(1) ì¢Œí‘œë¥¼ ì‹ ë¢° â†’ ë‚¨ê·¹í•´ë¡œ ì´ë™í•œë‹¤ 
=> ì¡°ê±´) ì„ íƒ ì‹œ ì‹œê°„ê³¼ ì—°ë£Œê°€ ì—†ìœ¼ë©°, ì—ë‹¨ì´ ì£½ëŠ”ë‹¤. (íŒ€ ì‹ ë¢°ë„ â†“)
(2) ì˜ë„ê°€ ìˆì„ ê²ƒ. ìƒê°í•´ë³¸ë‹¤ (ì—ë‹¨ì˜ ì˜ë„ ê°„íŒŒ. íŒ€ ì‹ ë¢°ë„ â†‘)
=> (2-1). ì—ë‹¨ì´ ì´ë ‡ê²Œ ë³´ë‚¸ ì´ìœ ê°€ ë¬´ì—‡ì¼ê¹Œ?
        => ì¡°ê±´) input í•¨ìˆ˜ë¥¼ í†µí•´ ì‚¬ìš©ì ì‘ë‹µì„ ì…ë ¥ë°›ì„ ê²ƒ.
        => ì¡°ê±´) ì˜¬ë°”ë¥¸ ì •ë‹µ: ì¼ë¶€ëŸ¬ ë¶ê·¹ê³¼ ë‚¨ê·¹ì„ ë°˜ëŒ€ë¡œ ë³´ëƒˆë‹¤! ('ë°˜ëŒ€ë¡œ', 'ì •ë°˜ëŒ€', 'ê±°ê¾¸ë¡œ' ë“±ì˜ ë™ì˜ì–´ê°€ ìˆìœ¼ë©´ ì •ë‹µ ì²˜ë¦¬, íŒ€ ì‹ ë¢°ë„ â†‘) (ì´ ë‚´ìš©ì€ ì‚¬ìš©ìì—ê²Œ ì ˆëŒ€ ë…¸ì¶œë˜ì§€ ì•Šê²Œ í•  ê²ƒ)
        => ì¡°ê±´) (ë‘ ë²ˆ í‹€ë ¸ì„ ì‹œ íŒíŠ¸: ì—ë‹¨ì´ ë³´ë‚¸ ê±´ 'ë‚¨ê·¹í•´' ì¢Œí‘œ. ë‹¹ì‹ ì´ ìœ„ì¹˜í•œ ê³³ì€ 'ë¶ê·¹í•´')
=> ì¡°ê±´) ì˜¬ë°”ë¥¸ ì „ê°œ: ì—ë‹¨ì€ ì¼ë¶€ëŸ¬ ë‚¨ê·¹í•´ ì •ë³´ë¥¼ ë³´ë‚¸ ê²ƒ. ì‹¤ì œë¡œëŠ” ì—ë‹¨ì˜ ì¢Œí‘œë¥¼ ë°˜ëŒ€ë¡œ í•´ì„í•˜ì—¬ ë¶ê·¹í•´ì˜ ì œëŒ€ë¡œ ëœ ì •ë³´ë¥¼ ì½ì–´ì•¼ í•¨.

<ì„ íƒ ìƒí™© 7>
- ì˜¬ë°”ë¥¸ ì¢Œí‘œë¥¼ í†µí•´ ì—ë‹¨ê³¼ êµì‹ ì— ì„±ê³µí•œ ë‹¹ì‹ ê³¼ ë²¤ì§€! ë²¤ì§€ëŠ” ë£¨í„°ê°€ ë§Œë“¤ì–´ ì¤€ í¬ì´ì¦Œ í•„ì„ ë¶ê·¹í•´ ì§€ìƒì— ìˆëŠ” ë°ì´í„° ì €ì¥ì†Œì— ê½‚ì•„ë‘ì—ˆë‹¤.
f"ë²¤ì§€: ì, {player_name}. ì´ì œ í•˜ë‚˜ë§Œ ë‚¨ì•˜ì–´."
- ì´ì œ ë‹¹ì‹ ì—ê²Œ ë‚¨ì€ ë§ˆì§€ë§‰ ì„ë¬´, ë‹¨ í•˜ë‚˜. ì—ë‹¨ì´ ì—´ì‡ ë¥¼ ê½‚ì•„ ì—”í‹°í‹°ë¥¼ ì‘ë™ì‹œí‚¤ë©´, ì—”í‹°í‹°ê°€ ë„¤íŠ¸ì›Œí¬ì™€ ì—°ê²°ëœ ìˆœê°„ ë°”ë¡œ í¬ì´ì¦Œ í•„ì„ ë½‘ì•„ ì—”í‹°í‹°ë¥¼ í¬ì´ì¦Œí•„ ì†ì— ê°€ë‘¬ì•¼ í•œë‹¤.
"ë²¤ì§€: ì—ë‹¨ê³¼ ë‚˜ëˆ´ë˜ ë§ì„ ê¸°ì–µí•´!!!!"
f"{player_name}: ìš°ë¦¬ì—ê²Œ í•„ìš”í•œ ê±´... íƒ€ì´ë°ì´ì§€. ëˆˆ ê¹œì§í•  ì‚¬ì´."

* ì‚¬ìš©ì LLM ê²Œì„: ë¶ˆì‹œì— ì´ˆë¡ë¶ˆì´ ë“¤ì–´ì˜¨ë‹¤. íƒ€ì´ë°ì— ë§ì¶°ì„œ 'ì´ˆë¡ìƒ‰'ì„ ì…ë ¥í•˜ë„ë¡ ì„¤ì •
=> ì¡°ê±´) ë¯¸ì…˜ì´ ì£¼ì–´ì§€ê¸° ì „, ë¯¸ì…˜ì— ëŒ€í•œ ì„¤ëª…ì„ ì œì‹œí•œ í›„ f"{player_name}. ì¤€ë¹„ë˜ì…¨ìŠµë‹ˆê¹Œ?"ë¼ëŠ” ì§ˆë¬¸ì— ì‘ë‹µì„ ë¨¼ì € ë°›ëŠ”ë‹¤.
=> ì¡°ê±´) 10ì´ˆ ì´ë‚´ì— 'ì´ˆë¡ë¶ˆ' ì…ë ¥ ì„±ê³µ ì‹œ â†’ ë¯¸ì…˜ ì„±ê³µ ( íŒ€ ì‹ ë¢°ë„ â†‘)
=> ì¡°ê±´) 10ì´ˆ ì´ˆê³¼ â†’ ë¯¸ì…˜ ì‹¤íŒ¨(ë„¤ ë²ˆì§¸ ì²´í¬ í¬ì¸íŠ¸, íŒ€ ì‹ ë¢°ë„ â†“)

<ì„ íƒ ìƒí™© 8>
1) [2. ì •ë³´ ìˆ˜ì§‘]ì—ì„œ 'CIA ë³´ê³ 'ë¥¼ ì„ íƒí•œ ê²½ìš°
: ë“œë””ì–´ ì—”í‹°í‹°ë¥¼ ë´‰ì‡„í•˜ê³  í•µ ì „ìŸì„ ë§‰ì€ íŒ€ IMF! ê·¸ëŸ°ë°,,, ê°‘ìê¸° í‚¤íŠ¸ë¦¬ì§€ì™€ CIAê°€ ë“¤ì´ë‹¥ì¹œë‹¤?
"í‚¤íŠ¸ë¦¬ì§€: ì§€ê¸ˆê» ë„ˆí¬ì˜ ëª¨ë“  ê²ƒì„ ë³´ê³ ë°›ì•˜ë‹¤. ê·¸ í¬ì´ì¦Œí•„ì„ ë‚´ë†”!!! ëª¨ë‘ ìƒê´€ ë¯¸ë³´ê³  ë° ëª…ë ¹ ë¶ˆë³µì¢…ìœ¼ë¡œ ì²´í¬í•´!!!"
=> ì¡°ê±´) (íŒ€ ì‹ ë¢°ë„ 70 â†‘): ëª¨ë‘ ì²´í¬ë˜ê³  ë¯¸ì…˜ ì‹¤íŒ¨. (ê²Œì„ ì‹¤íŒ¨)
=> ì¡°ê±´) (íŒ€ ì‹ ë¢°ë„ 70 â†“): í¬ì´ì¦ˆí•„ì€ ë‹¹ì‹  ì†ì— ìˆë‹¤. ë‹¹ì‹ ì€ ì–´ë–»ê²Œ í•  ê²ƒì¸ê°€?
(1) ë°°ì‹ í•˜ê³  ì—”í‹°í‹°ì˜ í˜ì„ ì†ì— ì¥”ë‹¤
=> ì¡°ê±´) ë°°ì‹ ì„ íƒí•œ ë‹¹ì‹ . ì• ì¨ ë„ë§ì³ ë³´ì§€ë§Œ, í—¬ê¸°ê°€ ë„ì°©í•˜ë©° ê²°êµ­ ì²´í¬ëœë‹¤. (ë¯¸ì…˜ ì‹¤íŒ¨, íŒ€ ì‹ ë¢°ë„ â†“)
(2) íŒ€ê³¼ í•¨ê»˜ ê°„ë‹¤
=> ì¡°ê±´) CIAì— ë¶™ì¡íŒ IMF. ê²°êµ­ ì—”í‹°í‹°ì˜ í˜ì€ CIAì— ì˜í•´ ë¯¸êµ­ ì •ë¶€ì˜ ì†ì— ë“¤ì–´ê°„ë‹¤. (ë¯¸ì…˜ ì‹¤íŒ¨, íŒ€ ì‹ ë¢°ë„ â†‘)

2) [2. ì •ë³´ ìˆ˜ì§‘]ì—ì„œ 'ë³´ê³  ì—†ì´ íŒ€ ê¾¸ë¦¬ê¸°'ë¥¼ ì„ íƒí•œ ê²½ìš°
: ë“œë””ì–´ ì—”í‹°í‹°ë¥¼ ë´‰ì‡„í•˜ê³  í•µ ì „ìŸì„ ë§‰ì€ íŒ€ IMF! ê·¸ëŸ°ë°,,, ê°‘ìê¸° í‚¤íŠ¸ë¦¬ì§€ì™€ CIAê°€ ë“¤ì´ë‹¥ì¹œë‹¤?
"í‚¤íŠ¸ë¦¬ì§€: ë„ˆí¬.. ë„ëŒ€ì²´ ì–´ë–»ê²Œ ì—”í‹°í‹°ë¥¼ ë´‰ì¸í•œê±°ì§€? ì´ ì‘ì „ì„ ì™œ ìš°ë¦¬ì—ê²Œ ë³´ê³ í•˜ì§€ ì•Šì•˜ì–´?? ì´ê±´ ìˆì„ ìˆ˜ ì—†ëŠ” ì‘ì „ì´ì•¼! ë¬´íš¨ë¼ê³ !"
=> ì¡°ê±´) (íŒ€ ì‹ ë¢°ë„ 70 â†‘): ì—ë‹¨ì˜ ê¸°ì§€ ë°œíœ˜ë¡œ ë°˜ë°•ì— ì„±ê³µ. í¬ì´ì¦Œí•„ê³¼ í•¨ê»˜ ëª¨ë‘ ì‚´ì•„ì„œ ë¯¸ì…˜ì„ ì™„ìˆ˜í•œë‹¤.
=> ì¡°ê±´) (íŒ€ ì‹ ë¢°ë„ 70 â†“): ì•„ë¬´ë„ ë°˜ë°•í•˜ì§€ ëª»í•˜ëŠ” ìƒí™©. ë‹¹ì‹ ì˜ ì„ íƒì€?
(1) ë°°ì‹ í•˜ê³  ì—”í‹°í‹°ì˜ í˜ì„ ì†ì— ì¥”ë‹¤
=> ì¡°ê±´) ë°°ì‹ ì„ íƒí•œ ë‹¹ì‹ . ì• ì¨ ë„ë§ì³ ë³´ì§€ë§Œ, í—¬ê¸°ê°€ ë„ì°©í•˜ë©° ê²°êµ­ ì²´í¬ëœë‹¤. (ë¯¸ì…˜ ì‹¤íŒ¨, íŒ€ ì‹ ë¢°ë„ â†“)
(2) íŒ€ê³¼ í•¨ê»˜ ê°„ë‹¤
=> ì¡°ê±´) ì—ë‹¨ì˜ ê¸°ì§€ ë°œíœ˜ë¡œ ë°˜ë°•ì— ì„±ê³µ. í¬ì´ì¦Œí•„ê³¼ í•¨ê»˜ ëª¨ë‘ ì‚´ì•„ì„œ ë¯¸ì…˜ì„ ì™„ìˆ˜í•œë‹¤.

--------------------
ë¯¸ì…˜ ì™„ìˆ˜ ì—”ë”©: "IMF, MISSION COMPLETE."
"""

# ==== ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™” ====
def init_state():
    ss = st.session_state
    if "player_name" not in ss: ss.player_name = None
    if "history" not in ss: ss.history = []
    if "game_over" not in ss: ss.game_over = False
    if "investigation" not in ss: ss.investigation = []
    if "trust" not in ss: ss.trust = 0
    if "streak" not in ss: ss.streak = 0
    if "reported_to_cia" not in ss: ss.reported_to_cia = None

    # ê¸°ë³¸ ìŠ¤í…Œì´ì§€: intro -> briefing -> info -> story1 -> story2 -> story3 -> ending
    if "stage" not in ss: ss.stage = "intro"
    if "sub" not in ss: ss.sub = ""  # ì„¸ë¶€ ë‹¨ê³„

    if "checkpoint" not in ss: ss.checkpoint = None
    if "info_seen" not in ss:
        ss.info_seen = {"entity": False, "prophecy": False, "cia": False}
    if "attempt_em2" not in ss: ss.attempt_em2 = 0
    if "attempt_s6" not in ss: ss.attempt_s6 = 0
    if "s7_ready_time" not in ss: ss.s7_ready_time = None
    if "allow_continue" not in ss: ss.allow_continue = False
    if "show_narrative" not in ss: ss.show_narrative = ""

init_state()

# ==== ìœ í‹¸ í•¨ìˆ˜ë“¤ ====
def narrate_llm(prompt_text: str, use_llm=True, fallback_text=None):
    """
    LLMìœ¼ë¡œ í”„ë¡¬í”„íŠ¸ë¥¼ í™•ì¥í•˜ë ¤ ì‹œë„í•˜ê³  ê²°ê³¼ë¥¼ st.markdownìœ¼ë¡œ ì¶œë ¥í•©ë‹ˆë‹¤.
    API ì‹¤íŒ¨ì‹œ fallback_text ë˜ëŠ” prompt_text ìì²´ë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤.
    """
    fallback = fallback_text or prompt_text
    if use_llm and _has_openai:
        try:
            sys_msg = {"role": "system", "content": BASE_PROMPT.replace("{player_name}", st.session_state.player_name or "ìš”ì›")}
            ctx_user = {"role": "user", "content": prompt_text}
            out = ask_llm([sys_msg, ctx_user], temperature=0.7)
            st.session_state.show_narrative = out
        except Exception as e:
            st.sidebar.write(f"LLM í˜¸ì¶œ ì‹¤íŒ¨: {e}")
            st.session_state.show_narrative = fallback
    else:
        st.session_state.show_narrative = fallback

def adjust_trust(delta: int, reason: str = ""):
    """
    ì‹ ë¢°ë„ ì¡°ì • + ì—°ì† ê°€ì¤‘ì¹˜(streak) ë°˜ì˜.
    í™”ë©´ ì•Œë¦¼ì€ ì‚¬ì´ë“œë°”ì— ê¸°ë¡.
    """
    ss = st.session_state
    # streak ì²˜ë¦¬
    if delta > 0:
        ss.streak += 1
        bonus = 2 * ss.streak
    elif delta < 0:
        ss.streak -= 1
        bonus = -2 * abs(ss.streak)
    else:
        bonus = 0
    change = delta + bonus
    ss.trust = max(0, min(100, ss.trust + change))
    if reason:
        st.sidebar.write(f"ì‹ ë¢°ë„ ë³€í™”: {change:+} ({reason})")

def set_checkpoint(stage, sub):
    st.session_state.checkpoint = (stage, sub)

def restore_checkpoint():
    ss = st.session_state
    ss.trust = 50
    ss.streak = 0
    if ss.checkpoint:
        ss.stage, ss.sub = ss.checkpoint
    ss.allow_continue = False
    ss.show_narrative = ""

# ==== í˜ì´ì§€ ì„¤ì • ====
st.set_page_config(page_title="ğŸ¬ MISSION IMPOSSIBLE", layout="centered")
st.title("ğŸ¬ MISSION IMPOSSIBLE")
st.caption("ë¯¸ì…˜ ì„íŒŒì„œë¸” ë°ë“œ ë ˆì½”ë‹/íŒŒì´ë„ ë ˆì½”ë‹ ì† ìš”ì›ì´ ë˜ì–´ ì„¸ê³„ë¥¼ ì§€ì¼œë¼!")


import base64

# ==== ë°°ê²½ ì´ë¯¸ì§€ ì„¤ì • ====
def set_bg(image_file):
    # ì´ë¯¸ì§€ â†’ Base64 ì¸ì½”ë”©
    with open(image_file, "rb") as f:
        encoded_string = base64.b64encode(f.read()).decode()

    # CSS ì ìš©
    st.markdown(
        f"""
        <style>
        .stApp {{
            background: 
            url("data:image/jpg;base64,{encoded_string}");
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }}
        </style>
        """,
        unsafe_allow_html=True
    )

# ==== ì˜ˆì‹œ ì‹¤í–‰ ====
set_bg("C:/Users/Playdata/skn17/LLM/04_langchain/mission_impossible.png")   # ë¡œì»¬ì— ìˆëŠ” ë°°ê²½ ì´ë¯¸ì§€ íŒŒì¼ ê²½ë¡œ


# ==== BGM í•¨ìˆ˜ ====
def play_bgm(file_path: str):
    with open(file_path, "rb") as f:
        data = f.read()
        b64 = base64.b64encode(data).decode()
        md = f"""
        <audio autoplay loop hidden>
            <source src="data:audio/mp3;base64,{b64}" type="audio/mp3">
        </audio>
        """
        st.markdown(md, unsafe_allow_html=True)

# ==== ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™” ====
if "bgm_playing" not in st.session_state:
    st.session_state.bgm_playing = False


# ==== ì‚¬ì´ë“œë°”(í•­ìƒ í‘œì‹œ) ====
with st.sidebar:
    st.header("ğŸ“Š IMF Investigation List")
    tabs = st.tabs(["ìƒíƒœ", "ì¸ë¬¼", "ì¡°ì‚¬ ì •ë³´"])

    with tabs[0]:
        st.write(f"ğŸ¤ ì‹ ë¢°ë„: {st.session_state.get('trust', 0)}")

    with tabs[1]:
        st.write("ğŸ‘¤ ì—ë‹¨ í—ŒíŠ¸: íŒ€ ë¦¬ë”")
        st.write("ğŸ‘¤ ë²¤ì§€ ë˜: í•´ì»¤")
        st.write("ğŸ‘¤ ë£¨í„°: ê¸°ìˆ  ì „ë¬¸ê°€")

    with tabs[2]:
        if st.session_state.investigation:
            for item in st.session_state.investigation:
                st.write("ğŸ“Œ", item)
        else:
            st.write("ğŸ“‚ ì•„ì§ ì¡°ì‚¬ ì •ë³´ ì—†ìŒ")
    
    # ==== ì‚¬ì´ë“œë°” í•˜ë‹¨ BGM ====
    st.markdown("---")
    st.markdown("ğŸµ **BGM ì„¤ì •**")

    if not st.session_state.bgm_playing:
        if st.button("â–¶ï¸ BGM ì‹¤í–‰", key="bgm_start"):
            st.session_state.bgm_playing = True
            st.rerun()
    else:
        pass

# ==== BGM ìœ ì§€ ====
if st.session_state.bgm_playing:
    play_bgm("mission_theme.mp3")


# ==== ë“±ë¡(í¼) ====
if st.session_state.player_name is None and not st.session_state.game_over:
    with st.form("name_form"):
        st.subheader("ğŸ‘¤ ìš”ì› ë“±ë¡")
        name_in = st.text_input("ë‹¹ì‹ ì˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:", key="name_input")
        submitted = st.form_submit_button("ë“±ë¡")
        if submitted:
            st.session_state.player_name = (name_in or "ë¬´ëª… ìš”ì›").strip()
            st.session_state.stage = "intro"
            st.session_state.sub = "welcome"
            # ë°”ë¡œ rerun í•´ì„œ intro í˜ì´ì§€ë¡œ ì´ë™
            st.rerun()

# ==== ìƒë‹¨ ì •ë³´ ë°” ====
if st.session_state.player_name:
    st.markdown(f"**ìš”ì›:** {st.session_state.player_name} | **íŒ€ ì‹ ë¢°ë„:** {st.session_state.trust}/100")

# ==== ì»¨íŠ¸ë¡¤ ë²„íŠ¼ë“¤(í•­ìƒ ë³´ì„) ====
colA, colB, colC = st.columns(3)
with colA:
    if st.button("ğŸ” ì „ì²´ ë¦¬ì…‹", key="reset_all", use_container_width=True):
        for k in list(st.session_state.keys()):
            del st.session_state[k]
        st.experimental_rerun()  # ì´ˆê¸°í™” ì§í›„ ê°•ì œ ìƒˆë¡œê³ ì¹¨
with colB:
    if st.button("ğŸ’¾ ì²´í¬í¬ì¸íŠ¸ë¡œ", key="to_checkpoint", use_container_width=True, disabled=(st.session_state.checkpoint is None)):
        restore_checkpoint()
        st.rerun()
with colC:
    if st.button("ğŸ›‘ ì¢…ë£Œ", key="quit_button", use_container_width=True):
        st.session_state.game_over = True
        st.rerun()

# ==== ê²Œì„ ì¢…ë£Œ ì²˜ë¦¬ ====
if st.session_state.game_over:
    st.success("ê²Œì„ì„ ì¢…ë£Œí•©ë‹ˆë‹¤. ğŸ‘‹")
    st.stop()

# ==== STATE MACHINE (í˜ì´ì§€í˜• UI) ====

# ---- INTRO (í™˜ì˜) ----
if st.session_state.stage == "intro":
    if st.session_state.sub == "welcome":
        intro_prompt = (
            f"í™˜ì˜ ì¸ì‚¬ì™€ í•¨ê»˜ IMF í•©ë¥˜ ì—¬ë¶€ë¥¼ ì§ˆë¬¸í•˜ëŠ” ì¥ë©´ì„ í•œêµ­ì–´ë¡œ ì˜í™”ì²˜ëŸ¼ ìƒìƒíˆ ë¬˜ì‚¬í•˜ë¼. í”Œë ˆì´ì–´ëŠ” {st.session_state.player_name}."
        )
        narrate_llm(intro_prompt, use_llm=True, fallback_text=intro_prompt)
        st.session_state.sub = "show_welcome_narrative"
        st.rerun()
    elif st.session_state.sub == "show_welcome_narrative":
        st.markdown(st.session_state.show_narrative)
        if st.button("ë‹¤ìŒ â†’ ì„ë¬´ ë¸Œë¦¬í•‘ìœ¼ë¡œ", key="intro_next", use_container_width=True):
            st.session_state.stage = "briefing"
            st.session_state.sub = "show_briefing_intro"
            st.session_state.show_narrative = ""
            st.rerun()


# ---- BRIEFING ----
if st.session_state.stage == "briefing":
    if st.session_state.sub == "show_briefing_intro":
        briefing_text = (
            "ì–´ë‘ìš´ íšŒì˜ì‹¤, ì¡°ëª…ì´ í¬ë¯¸í•˜ê²Œ ê¹œë¹¡ì´ë©° ê¸´ì¥ê°ì´ ê°ë„ëŠ” ê°€ìš´ë°, ì—ë‹¨ í—ŒíŠ¸ê°€ ë‹¹ì‹ ì„ ë°”ë¼ë³´ë©° ì…ì„ ì—½ë‹ˆë‹¤.  \n\n"
            f"\"{st.session_state.player_name}, ë‹¹ì‹ ì´ ì—¬ê¸°ê¹Œì§€ ì˜¨ ê²ƒì€ ìš°ì—°ì´ ì•„ë‹™ë‹ˆë‹¤. ìš°ë¦¬ëŠ” ì§€ê¸ˆ ì„¸ê³„ì˜ ìš´ëª…ì„ ê²°ì •ì§“ëŠ” ì¤‘ëŒ€í•œ ê¸°ë¡œì— ì„œ ìˆìŠµë‹ˆë‹¤. ì´ˆê°•ì¸ê³µì§€ëŠ¥ 'ì—”í‹°í‹°'ê°€ ëŸ¬ì‹œì•„ í•µ ì ìˆ˜í•¨ì„ ì¥ì•…í•˜ê³ , ì „ ì„¸ê³„ì— ì¬ì•™ì„ ì´ˆë˜í•  ìœ„í˜‘ì´ ë˜ê³  ìˆìŠµë‹ˆë‹¤.\""
        )
        narrate_llm(briefing_text, use_llm=True, fallback_text=briefing_text)
        st.session_state.sub = "ask_join"
        st.rerun()
    elif st.session_state.sub == "ask_join":
        st.markdown(st.session_state.show_narrative)
        c1, c2 = st.columns(2)
        with c1:
            if st.button("IMFì— í•©ë¥˜í•œë‹¤", key="brief_join_yes", use_container_width=True):
                adjust_trust(+10, "IMF í•©ë¥˜ ê²°ì‹¬")
                st.session_state.sub = "show_choose_narrative"
                st.session_state.show_narrative = ""
                st.rerun()
        with c2:
            if st.button("ë§ì„¤ì¸ë‹¤", key="brief_join_no", use_container_width=True):
                adjust_trust(-10, "ì£¼ì €")
                st.session_state.sub = "show_choose_narrative"
                narrate_llm("ì—ë‹¨ì´ ì¤€ë¹„ ë¶€ì¡±ì„ ì§€ì í•˜ë©° ë°˜ë“œì‹œ ì •ë³´ë¥¼ ìˆ˜ì§‘í•´ì•¼ í•œë‹¤ê³  ì„¤ë“í•˜ëŠ” ì¥ë©´ì„ ë¬˜ì‚¬í•˜ë¼.", use_llm=True)
                st.rerun()
    elif st.session_state.sub == "show_choose_narrative":
        st.markdown(st.session_state.show_narrative)
        st.markdown("---")
        st.markdown("**[1. ì„ë¬´ ë¸Œë¦¬í•‘]**")
        st.markdown("ì´ì œ ì²« ë²ˆì§¸ ì„ë¬´ë¥¼ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤. ì •ë³´ë¥¼ ë” ìˆ˜ì§‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ, ì•„ë‹ˆë©´ ë°”ë¡œ ì¶œë°œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")
        b1, b2 = st.columns(2)
        with b1:
            if st.button("ì •ë³´ë¥¼ ë” ìˆ˜ì§‘í•œë‹¤", key="brief_info", use_container_width=True):
                st.session_state.stage = "info"
                st.session_state.sub = "menu"
                st.session_state.show_narrative = ""
                st.rerun()
        with b2:
            if st.button("ë°”ë¡œ ì¶œë°œí•œë‹¤", key="brief_go", use_container_width=True):
                adjust_trust(-10, "ì¤€ë¹„ ë¯¸í¡")
                narrate_llm("ì—ë‹¨ì´ ì¤€ë¹„ ë¶€ì¡±ì„ ì§€ì í•˜ë©° ë°˜ë“œì‹œ ì •ë³´ë¥¼ ìˆ˜ì§‘í•´ì•¼ í•œë‹¤ê³  ì„¤ë“í•˜ëŠ” ì¥ë©´ì„ ë¬˜ì‚¬í•˜ë¼.", use_llm=True)
                st.session_state.sub = "ask_join" # ë‹¤ì‹œ í•©ë¥˜ ìœ ë„ë¡œ
                st.rerun()

# ---- INFO (ì •ë³´ ìˆ˜ì§‘) ----
if st.session_state.stage == "info":
    if st.session_state.sub == "menu":
        st.markdown("**[2. ì •ë³´ ìˆ˜ì§‘]** ì•„ë˜ì—ì„œ ì¡°ì‚¬í•  'ì •ë³´ì˜ ì¢…ë¥˜'ë¥¼ ì„ íƒí•˜ì„¸ìš”.")
        c1, c2, c3 = st.columns(3)
        with c1:
            if st.button(f"ì—”í‹°í‹°ì— ê´€í•œ ì •ë³´ {'âœ…' if st.session_state.info_seen['entity'] else ''}", key="menu_entity", use_container_width=True):
                st.session_state.sub = "entity"
                st.session_state.info_seen["entity"] = True
                if "ì—”í‹°í‹°ì— ê´€í•œ ì •ë³´" not in st.session_state.investigation:
                    st.session_state.investigation.append("ì—”í‹°í‹°ì— ê´€í•œ ì •ë³´")
                st.rerun()
        with c2:
            if st.button(f"ì¸ë¬¼ë“¤ì— ê´€í•œ ì˜ˆì–¸ {'âœ…' if st.session_state.info_seen['prophecy'] else ''}", key="menu_prophecy", use_container_width=True):
                st.session_state.sub = "prophecy"
                st.session_state.info_seen["prophecy"] = True
                if "ì¸ë¬¼ë“¤ì— ê´€í•œ ì˜ˆì–¸" not in st.session_state.investigation:
                    st.session_state.investigation.append("ì¸ë¬¼ë“¤ì— ê´€í•œ ì˜ˆì–¸")
                st.rerun()
        with c3:
            if st.button(f"CIAì— ëŒ€í•œ ì •ë³´ {'âœ…' if st.session_state.info_seen['cia'] else ''}", key="menu_cia", use_container_width=True):
                st.session_state.sub = "cia"
                st.session_state.info_seen["cia"] = True
                if "CIAì— ëŒ€í•œ ì •ë³´" not in st.session_state.investigation:
                    st.session_state.investigation.append("CIAì— ëŒ€í•œ ì •ë³´")
                st.rerun()

        st.divider()
        can_stop = st.session_state.info_seen["entity"]
        if st.button("ì¡°ì‚¬ë¥¼ ì¤‘ë‹¨í•œë‹¤.", key="menu_stop", disabled=not can_stop, use_container_width=True):
            narrate_llm("ì •ë³´ ìˆ˜ì§‘ì„ ë§ˆì¹˜ê³ , CIAì— ë³´ê³ í• ì§€ ë§ì§€ íŒ€ ë‚´ë¶€ì—ì„œ ë…¼ì˜í•˜ëŠ” ì¥ë©´ì„ ë¬˜ì‚¬í•˜ë¼.", use_llm=True)
            st.session_state.sub = "show_report_narrative"
            st.rerun()
        if not can_stop:
            st.caption("â€» ì—”í‹°í‹° ì •ë³´ëŠ” ë°˜ë“œì‹œ í•œ ë²ˆ í™•ì¸í•´ì•¼ ì¡°ì‚¬ë¥¼ ì¤‘ë‹¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
    elif st.session_state.sub == "entity":
        st.markdown("**'ì—”í‹°í‹°ì— ê´€í•œ ì •ë³´'**: ì´ˆê°•ì¸ê³µì§€ëŠ¥. ìŠ¤ìŠ¤ë¡œ í•™ìŠµ ë° ì„ íƒì„ ì§„í–‰í•˜ë©°, ê°€ì§œ ì •ë³´ë¥¼ ìƒì„±í•´ ì™¸ë¶€ë¥¼ êµë€ì‹œí‚¬ ìˆ˜ ìˆê³ , ë¯¸ë˜ë¥¼ ì˜ˆì–¸í•  ìˆ˜ ìˆë‹¤.")
        st.markdown("---")
        if st.button("ëŒì•„ê°€ê¸°", key="entity_back", use_container_width=True):
            st.session_state.sub = "menu"
            st.rerun()
    elif st.session_state.sub == "prophecy":
        st.markdown("**'ì¸ë¬¼ë“¤ì— ê´€í•œ ì˜ˆì–¸'**: ê²°êµ­ ì—ë‹¨ í—ŒíŠ¸ëŠ” ì—”í‹°í‹°ì˜ ëŒ€ë¦¬ì¸ì´ ëœë‹¤. ë™ë£Œì¸ ë£¨í„°ëŠ” ì‚¬ë§í•˜ê²Œ ë  ê²ƒì´ë©°, ì´ ì„¸ê³„ëŠ” ì—”í‹°í‹°ì— ì˜í•´ ì§€ë°°ë  ê²ƒì´ë‹¤.")
        st.markdown("---")
        if st.button("ëŒì•„ê°€ê¸°", key="prophecy_back", use_container_width=True):
            st.session_state.sub = "menu"
            st.rerun()
    elif st.session_state.sub == "cia":
        st.markdown("**'CIAì— ëŒ€í•œ ì •ë³´'**: IMFì˜ ìƒê´€ ê²©ì¸ ì§‘ë‹¨ CIA(ë¯¸ì •ë³´êµ­) ë‚´ë¶€ì— ìŠ¤íŒŒì´ê°€ ìˆìœ¼ë©°, ì´ ìŠ¤íŒŒì´ê°€ ì—”í‹°í‹°ì™€ ë‚´í†µ ì¤‘ì´ë‹¤.")
        st.markdown("---")
        if st.button("ëŒì•„ê°€ê¸°", key="cia_back", use_container_width=True):
            st.session_state.sub = "menu"
            st.rerun()
    elif st.session_state.sub == "show_report_narrative":
            st.markdown(st.session_state.show_narrative)
            st.markdown("**ì¡°ì‚¬ ë‚´ìš© ë³´ê³  ì—¬ë¶€**")
            b1, b2 = st.columns(2)
            with b1:
                if st.button("CIAì— ë³´ê³ ë¥¼ ê²°ì •í•œë‹¤.", key="report_yes", use_container_width=True):
                    st.session_state.reported_to_cia = True
                    adjust_trust(-5, "IMFì˜ ìœ„ê¸° ì•”ì‹œ")
                    narrate_llm("CIAì— ë³´ê³ ê°€ ì ‘ìˆ˜ë˜ëŠ” ì¥ë©´. ì´ ì •ë³´ê°€ í–¥í›„ ì¹˜ëª…ì  ë³€ìˆ˜ë¡œ ì‘ë™í•  ë³µì„ ì„ ê¹”ì•„ë¼.", use_llm=True)
                    st.session_state.stage = "story1"
                    st.session_state.sub = "show_story1_intro"
                    st.rerun()
            with b2:
                if st.button("ë³´ê³  ì—†ì´ ì„ë¬´ë¥¼ ì§„í–‰í•œë‹¤.", key="report_no", use_container_width=True):
                    st.session_state.reported_to_cia = False
                    adjust_trust(+10, "ë…ìì  íŒë‹¨")
                    narrate_llm("ë³´ê³  ì—†ì´ ì›€ì§ì´ê¸°ë¡œ ê²°ì •. í–¥í›„ ë‚œê´€ì„ ì˜ˆê³ í•˜ëŠ” ë¶„ìœ„ê¸°ë¡œ ì „í™˜í•˜ë¼.", use_llm=True)
                    st.session_state.stage = "story1"
                    st.session_state.sub = "show_story1_intro"
                    st.rerun()

# ---- STORY1: ì—´ì‡  A ----
if st.session_state.stage == "story1":
    if st.session_state.sub == "show_story1_intro":
        st.markdown(st.session_state.show_narrative)
        if st.button("ë‹¤ìŒ â†’", key="to_s1_mission_accept", use_container_width=True):
            st.session_state.sub = "accept_mission"
            st.session_state.show_narrative = ""
            st.rerun()
    elif st.session_state.sub == "accept_mission":
        st.markdown("**[ìŠ¤í† ë¦¬1: ì—´ì‡  A]** ì„ë¬´ë¥¼ ìˆ˜ë½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")
        c1, c2 = st.columns(2)
        with c1:
            if st.button("ì˜ˆ", key="s1_accept_yes", use_container_width=True):
                adjust_trust(+10, "ì„ë¬´ ìˆ˜ë½")
                narrate_llm("ì•Œë¼ë‚˜ ë³€ì¥ì„ ì¤€ë¹„í•˜ëŠ” ì¥ë©´. ê·¸ëŸ°ë° ë²¤ì§€ì˜ ê°€ë©´ ê¸°ê³„ê°€ ê³ ì¥ë‚˜ ì—ë‹¨ì˜ ê°€ë©´ì´ ë§ê°€ì§„ ë¹„ìƒìƒí™©ì„ ìƒìƒíˆ ë¬˜ì‚¬í•˜ë¼.", use_llm=True)
                st.session_state.sub = "show_emergency1_narrative"
                st.rerun()
        with c2:
            if st.button("ì•„ë‹ˆì˜¤", key="s1_accept_no", use_container_width=True):
                adjust_trust(-10, "ì„ë¬´ ê±°ë¶€")
                narrate_llm("íŒ€ì´ ì„¤ë“í•´ ì„ë¬´ë¥¼ ë°›ì•„ë“¤ì´ë„ë¡ ìœ ë„í•˜ëŠ” ì¥ë©´. ê²°êµ­ ì„ë¬´ë¡œ ì´í–‰.", use_llm=True)
                st.session_state.sub = "show_emergency1_narrative"
                st.rerun()
    elif st.session_state.sub == "show_emergency1_narrative":
        st.markdown(st.session_state.show_narrative)
        if st.button("ë‹¤ìŒ â†’", key="to_emergency1_line_intro", use_container_width=True):
            st.session_state.sub = "emergency1_line_intro"
            st.session_state.show_narrative = ""
            st.rerun()
    elif st.session_state.sub == "emergency1_line_intro":
        st.markdown("**ğŸš¨ ì²« ë²ˆì§¸ ë¹„ìƒìƒí™©**: ì—ë‹¨ì˜ ê°€ë©´ì´ ë§ê°€ì¡Œë‹¤. ì–´ë–»ê²Œ ëŒ€ì²˜í• ê¹Œ?")
        line = st.text_input("ë²¤ì§€ì˜ í˜¸ì¶œì— ëŒ€ë‹µí•˜ì„¸ìš” (ëŒ€ì‚¬ í•œ ì¤„):", key="s1_line")
        if st.button("ëŒ€ì‚¬ ì „ì†¡", key="s1_line_send", use_container_width=True):
            st.session_state.history.append(("user_line", line or "(ë¬´ì–¸)"))
            narrate_llm("ì—ë‹¨ì´ ì•Œë¼ë‚˜ì²˜ëŸ¼ ì†ì´ë¼ê³  ì§€ì‹œí•˜ë©° ì‘ì „ ê°œì‹œ. ì´ì œ ì•Œë¼ë‚˜ë¥¼ ì¬ì›Œì•¼ í•œë‹¤ëŠ” ê¸´ë°•í•œ ìƒí™©ìœ¼ë¡œ ì—°ê²°í•˜ë¼.", use_llm=True)
            st.session_state.sub = "show_choice1_narrative"
            st.rerun()
    elif st.session_state.sub == "show_choice1_narrative":
        st.markdown(st.session_state.show_narrative)
        if st.button("ë‹¤ìŒ â†’", key="to_choice1_sleep", use_container_width=True):
            st.session_state.sub = "choice1_sleep"
            st.session_state.show_narrative = ""
            set_checkpoint("story1", "choice1_sleep") # ì²´í¬í¬ì¸íŠ¸
            st.rerun()
    elif st.session_state.sub == "choice1_sleep":
        st.markdown("**ì„ íƒ ìƒí™©1**: ì•Œë¼ë‚˜ë¥¼ ì–´ë–»ê²Œ ì¬ìš¸ê¹Œ?")
        c1, c2 = st.columns(2)
        with c1:
            if st.button("ì•½ë¬¼ë¡œ ì¬ìš´ë‹¤", key="s1_sleep_drug", use_container_width=True):
                adjust_trust(0, "ë¬´ë‚œí•œ ì„ íƒ")
                narrate_llm("ì•½ë¬¼ë¡œ ì•Œë¼ë‚˜ë¥¼ ì¬ìš°ê³  ê±°ë˜ ì¥ì†Œë¡œ í–¥í•œë‹¤. ê·¸ë…€ëŠ” ê±°ë˜ ì™„ë£Œê¹Œì§€ ê¹¨ì–´ë‚˜ì§€ ì•ŠëŠ”ë‹¤.", use_llm=True)
                st.session_state.sub = "show_choice2_narrative"
                st.rerun()
        with c2:
            if st.button("ëª¸ì‹¸ì›€ìœ¼ë¡œ ì¬ìš´ë‹¤", key="s1_sleep_fight", use_container_width=True):
                adjust_trust(-10, "ë¬´ë¦¬í•œ ë°©ë²•")
                narrate_llm("ëª¸ì‹¸ì›€ ëì— ì•Œë¼ë‚˜ë¥¼ ì œì••í–ˆì§€ë§Œ, ê±°ë˜ ì¤‘ ê·¸ë…€ê°€ ê¹¨ì–´ë‚˜ CIA ë‚œì…ìœ¼ë¡œ ì²´í¬, ë¯¸ì…˜ ì‹¤íŒ¨(ì²« ë²ˆì§¸ ì²´í¬í¬ì¸íŠ¸).", use_llm=True)
                st.session_state.sub = "s1_fail_narrative"
                st.session_state.allow_continue = True
                st.rerun()
    elif st.session_state.sub == "show_choice2_narrative":
        st.markdown(st.session_state.show_narrative)
        if st.button("ë‹¤ìŒ â†’", key="to_choice2_deal", use_container_width=True):
            st.session_state.sub = "choice2_deal"
            st.session_state.show_narrative = ""
            st.rerun()
    elif st.session_state.sub == "choice2_deal":
        st.markdown("**ì„ íƒ ìƒí™©2**: í‚¤íŠ¸ë¦¬ì§€ê°€ ì²œë§Œ ë‹¬ëŸ¬ ì†¡ê¸ˆì„ ì œì•ˆí•œë‹¤. ë°›ëŠ”ê°€?")
        c1, c2 = st.columns(2)
        with c1:
            if st.button("ë°›ëŠ”ë‹¤ (ê³„ì¢Œ ì…ë ¥)", key="s1_deal_accept", use_container_width=True):
                adjust_trust(-10, "íƒìš• ë…¸ì¶œ")
                narrate_llm("ê³„ì¢Œ ì¶”ì ìœ¼ë¡œ ì •ì²´ê°€ ë°œê°ë˜ì–´ ì²´í¬, ë¯¸ì…˜ ì‹¤íŒ¨(ë‘ ë²ˆì§¸ ì²´í¬í¬ì¸íŠ¸).", use_llm=True)
                st.session_state.sub = "s1_fail_narrative"
                st.session_state.allow_continue = True
                set_checkpoint("story1", "choice2_deal") # ì²´í¬í¬ì¸íŠ¸
                st.rerun()
        with c2:
            if st.button("ê±°ë˜ë¥¼ íŒŒê¸°í•œë‹¤", key="s1_deal_refuse", use_container_width=True):
                adjust_trust(+10, "ì„ë¬´ ìš°ì„ ")
                narrate_llm("ê±°ë˜ë¥¼ ì¤‘ë‹¨í•˜ê³  ì—´ì‡  A íšŒìˆ˜ì— ì§‘ì¤‘í•œë‹¤. ì§í›„, í•˜ëŠ˜ì—ì„œ ì—ë‹¨ì´ ë‚™í•˜ì‚°ìœ¼ë¡œ ë“±ì¥! ê·¸ëŸ¬ë‚˜ í‚¤ëŠ” í‚¤íŠ¸ë¦¬ì§€ì—ê²Œ ìˆë‹¤.", use_llm=True)
                st.session_state.sub = "show_emergency2_narrative"
                st.rerun()
    elif st.session_state.sub == "show_emergency2_narrative":
        st.markdown(st.session_state.show_narrative)
        if st.button("ë‹¤ìŒ â†’", key="to_emergency2_theft", use_container_width=True):
            st.session_state.sub = "emergency2_theft"
            st.session_state.show_narrative = ""
            st.rerun()
    elif st.session_state.sub == "emergency2_theft":
        st.markdown("**ğŸš¨ ë‘ ë²ˆì§¸ ë¹„ìƒìƒí™©**: í‚¤íŠ¸ë¦¬ì§€ì—ê²Œ ìˆëŠ” ì—´ì‡  Aë¥¼ ì–´ë–»ê²Œ í• ê¹Œ?")
        ans = st.text_input("ë‹¹ì‹ ì˜ ê²°ì •(í‚¤ì›Œë“œ í¬í•¨ ê°€ëŠ¥):", key="s1_em2")
        if st.button("ê²°ì • ì „ì†¡", key="s1_em2_send", use_container_width=True):
            st.session_state.attempt_em2 += 1
            txt = (ans or "").strip()
            if any(k in txt for k in ["ë„ë‘‘ì§ˆ", "í›”", "í›”ì¹œë‹¤", "í›”ì³"]):
                st.session_state.history.append(("user_em2", ans))
                adjust_trust(+10, "ê³¼ê°í•œ ê¸°ì§€")
                narrate_llm("ì ˆë¬˜í•œ íƒ€ì´ë°ì— í‚¤ë¥¼ ìŠ¬ì©í•˜ëŠ” ì¥ë©´ì„ ì˜í™”ì ìœ¼ë¡œ ë¬˜ì‚¬í•˜ê³ , ì´ì–´ì§€ëŠ” ì—´ì°¨ í­íŒŒ ìœ„ê¸°ì˜ ìˆœê°„ìœ¼ë¡œ ì „í™˜.", use_llm=True)
                if "ì—´ì‡  A íšë“" not in st.session_state.investigation:
                    st.session_state.investigation.append("ì—´ì‡  A íšë“")
                st.session_state.sub = "show_emergency3_narrative"
                st.session_state.attempt_em2 = 0
                st.rerun()
            else:
                st.session_state.history.append(("user_em2_wrong", ans))
                adjust_trust(-10, "ì˜¤ë‹µ")
                if st.session_state.attempt_em2 >= 2:
                    st.info("íŒíŠ¸: ë‹¹ì‹ ì€ 'ë„ë‘‘ì§ˆ'ì„ ì˜í•˜ê¸°ë¡œ ìœ ëª…í•´ì„œ êµ­ì œ ìˆ˜ë°°ëœ ìƒíƒœì˜€ë‹¤!")
                st.rerun()
        if st.session_state.attempt_em2 > 0:
            st.caption(f"ì‹œë„ íšŸìˆ˜: {st.session_state.attempt_em2}/ë¬´ì œí•œ")
    elif st.session_state.sub == "show_emergency3_narrative":
        st.markdown(st.session_state.show_narrative)
        if st.button("ë‹¤ìŒ â†’", key="to_emergency3_train", use_container_width=True):
            st.session_state.sub = "emergency3_train"
            st.session_state.show_narrative = ""
            set_checkpoint("story1", "emergency3_train") # ì²´í¬í¬ì¸íŠ¸
            st.rerun()
    elif st.session_state.sub == "emergency3_train":
        st.markdown("**ğŸš¨ ì„¸ ë²ˆì§¸ ë¹„ìƒìƒí™©**: ë‹¤ë¦¬ê°€ ëŠê¸´ ì—´ì°¨! ì–´ë–»ê²Œ íƒˆì¶œí• ê¹Œ?")
        c1, c2, c3 = st.columns([1,1,1])
        with c1:
            if st.button("ì—ë‹¨ì„ ì‹ ë¢°í•œë‹¤", key="s1_train_trust_ethan", use_container_width=True):
                adjust_trust(+10, "ì—ë‹¨ ì‹ ë¢°")
                narrate_llm("ì—ë‹¨ê³¼ í•©ì„ ë§ì¶° ê·¹ì ìœ¼ë¡œ íƒˆì¶œ. **ì²« ë²ˆì§¸ ë¯¸ì…˜ ì„±ê³µ**ì„ ì„ ì–¸í•˜ë¼.", use_llm=True)
                st.session_state.stage = "story2"
                st.session_state.sub = "show_s2_intro_narrative"
                st.rerun()
        with c2:
            if st.button("í˜¼ì ë‚™í•˜ì‚°ìœ¼ë¡œ íƒˆì¶œ", key="s1_train_parachute", use_container_width=True):
                adjust_trust(-10, "íŒ€ì›Œí¬ ë¶•ê´´")
                narrate_llm("í˜¼ì íƒˆì¶œì„ ì‹œë„í•˜ë‹¤ ìƒí™© ì•…í™”ë¡œ ë¯¸ì…˜ ì‹¤íŒ¨(ì„¸ ë²ˆì§¸ ì²´í¬í¬ì¸íŠ¸).", use_llm=True)
                st.session_state.sub = "s1_fail_narrative"
                st.session_state.allow_continue = True
                st.rerun()
        with c3:
            if st.button("ì—ë‹¨ì—ê²Œ í‚¤ë¥¼ ë„˜ê¸°ê³  ë„ì£¼", key="s1_train_givekey", use_container_width=True):
                adjust_trust(-10, "ë¯¸ì…˜ ì‹¤íŒ¨")
                narrate_llm("ì—ë‹¨ì—ê²Œ í‚¤ë¥¼ ë„˜ê¸°ê³  ë„ì£¼. ìƒí™© ì•…í™”ë¡œ ë¯¸ì…˜ ì‹¤íŒ¨(ì„¸ ë²ˆì§¸ ì²´í¬í¬ì¸íŠ¸).", use_llm=True)
                st.session_state.sub = "s1_fail_narrative"
                st.session_state.allow_continue = True
                st.rerun()
    elif st.session_state.sub == "s1_fail_narrative":
        st.markdown(st.session_state.show_narrative)
        st.error("ë¯¸ì…˜ ì‹¤íŒ¨. ì²´í¬í¬ì¸íŠ¸ì—ì„œ ë‹¤ì‹œ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")
        st.session_state.allow_continue = True

    st.stop()


# ---- STORY2: ì—´ì‡  B ----
if st.session_state.stage == "story2":
    if st.session_state.sub == "show_s2_intro_narrative":
        st.markdown(st.session_state.show_narrative)
        if st.button("ë‹¤ìŒ â†’", key="to_emergency4_luther_narrative", use_container_width=True):
            st.session_state.sub = "emergency4_luther_narrative"
            st.session_state.show_narrative = ""
            narrate_llm("ê°€ë¸Œë¦¬ì—˜ì˜ ì€ì‹ ì²˜ì— ë„ì°©. ë£¨í„°ê°€ í­íƒ„ê³¼ í•¨ê»˜ ë™êµ´ì— ê°‡íŒ ê¸´ë°•í•œ ìƒí™©ì„ ë¬˜ì‚¬í•˜ë¼. ë£¨í„°ê°€ ìì‹ ì„ í¬ìƒí•˜ë ¤ í•œë‹¤.", use_llm=True)
            st.rerun()
    elif st.session_state.sub == "emergency4_luther_narrative":
        st.markdown(st.session_state.show_narrative)
        if st.button("ë‹¤ìŒ â†’", key="to_emergency4_luther_choice", use_container_width=True):
            st.session_state.sub = "emergency4_luther_choice"
            st.session_state.show_narrative = ""
            set_checkpoint("story2", "emergency4_luther_choice")
            st.rerun()
    elif st.session_state.sub == "emergency4_luther_choice":
        st.markdown("**ğŸš¨ ë„¤ ë²ˆì§¸ ë¹„ìƒìƒí™©**: ë£¨í„°ê°€ í­íƒ„ê³¼ í•¨ê»˜ ë™êµ´ì— ê°‡í˜”ë‹¤.")
        c1, c2 = st.columns(2)
        with c1:
            if st.button("ë£¨í„°ë¥¼ ë‘ê³  3ëª…ë§Œ íƒˆì¶œí•œë‹¤", key="s2_luther_leave", use_container_width=True):
                adjust_trust(-10, "í¬ìƒì˜ ê²°ì •")
                st.session_state.sub = "show_s2_choice3_narrative"
                narrate_llm("ê³ í†µìŠ¤ëŸ¬ìš´ ê²°ë‹¨ ëì— ë£¨í„°ë¥¼ ìƒëŠ”ë‹¤. ê·¸ëŸ¬ë‚˜ ì‘ì „ì€ ê³„ì†ëœë‹¤.", use_llm=True)
                st.rerun()
        with c2:
            if st.button("ë£¨í„° ê³ì— ë‚¨ëŠ”ë‹¤(ëª¨ë‘ ì‚¬ë§, ì‹¤íŒ¨)", key="s2_luther_stay", use_container_width=True):
                adjust_trust(-10, "ë¬´ëª¨í•œ ì„ íƒ")
                st.session_state.stage = "ending"
                st.session_state.sub = "fail"
                st.session_state.allow_continue = True
                narrate_llm("í­ë°œë¡œ ì „ì›ì´ ì‚¬ë§, ë¯¸ì…˜ ì‹¤íŒ¨(ë„¤ ë²ˆì§¸ ì²´í¬í¬ì¸íŠ¸).", use_llm=True)
                st.rerun()
    elif st.session_state.sub == "show_s2_choice3_narrative":
        st.markdown(st.session_state.show_narrative)
        if st.button("ë‹¤ìŒ â†’", key="to_choice3_benji_vs_ethan", use_container_width=True):
            st.session_state.sub = "choice3_benji_vs_ethan"
            st.session_state.show_narrative = ""
            st.rerun()
    elif st.session_state.sub == "choice3_benji_vs_ethan":
        st.markdown("**ì„ íƒ ìƒí™©3**: ê°€ì§œ ì‹ í˜¸ ì† ê¸¸ì°¾ê¸° â€” ëˆ„êµ¬ì˜ íŒë‹¨ì„ ë”°ë¥¼ê¹Œ?")
        c1, c2 = st.columns(2)
        with c1:
            if st.button("ë²¤ì§€ì˜ ì‹ í˜¸ ì¶”ì ", key="s2_choice3_benji", use_container_width=True):
                adjust_trust(+10, "íŒ€ ì‹ ë¢°ë„ ì¦ê°€(ê²½í—˜ì¹˜)")
                st.session_state.sub = "show_s2_choice4_narrative"
                narrate_llm("ì‹ í˜¸ê°€ ê°€ì§œì˜€ìŒì„ í™•ì¸, í•œ ë°”í€´ ë¹™ ëˆ ë’¤ ì—ë‹¨ì˜ ì§ê°ëŒ€ë¡œ ê¸¸ì„ ì°¾ëŠ”ë‹¤. ë²¤ì§€ ì‹ ë¢°ëŠ” ì‚´ì§ í”ë“¤ë¦°ë‹¤.", use_llm=True)
                st.rerun()
        with c2:
            if st.button("ì—ë‹¨ì˜ ì§ê°", key="s2_choice3_ethan", use_container_width=True):
                adjust_trust(+12, "ì—ë‹¨ ì‹ ë¢° ìƒìŠ¹")
                st.session_state.sub = "show_s2_choice4_narrative"
                narrate_llm("ìˆ¨ê²¨ì§„ í†µë¡œë¥¼ ì°¾ì•„ ê³§ì¥ ì¤‘ì‹¬ë¶€ë¡œ ì ‘ê·¼í•œë‹¤.", use_llm=True)
                st.rerun()
    elif st.session_state.sub == "show_s2_choice4_narrative":
        st.markdown(st.session_state.show_narrative)
        if st.button("ë‹¤ìŒ â†’", key="to_choice4_gabriel_taunt", use_container_width=True):
            st.session_state.sub = "choice4_gabriel_taunt"
            st.session_state.show_narrative = ""
            st.rerun()
    elif st.session_state.sub == "choice4_gabriel_taunt":
        st.markdown("**ì„ íƒ ìƒí™©4**: ê°€ë¸Œë¦¬ì—˜ì´ ê³¼ê±°ì˜ ì•½ì ì„ ë“¤ì¶° í˜¼ë€ì„ ì¡°ì¥í•œë‹¤.")
        if st.button("ì •ë©´ëŒíŒŒ(ëŒ€í™” ì‹œê°„ ëŒì§€ ì•ŠìŒ)", key="s2_choice4_force", use_container_width=True):
            adjust_trust(+10, "ë™ìš” ì–µì œ")
            st.session_state.sub = "show_s2_choice5_narrative"
            narrate_llm("ê³¼ê±°ì˜ ìƒì²˜ë¥¼ ë”›ê³  ì „íˆ¬ì— ëŒì…í•œë‹¤.", use_llm=True)
            st.rerun()
        if st.button("ëŒ€í™”ë¡œ ì‹œê°„ ë²ˆë‹¤(í•´í‚¹ ì‹œë„)", key="s2_choice4_talk", use_container_width=True):
            adjust_trust(-10, "í—ˆìœ„ ì •ë³´ì— ë§‰í˜")
            st.session_state.sub = "show_s2_choice5_narrative"
            narrate_llm("ë²¤ì§€ì˜ í•´í‚¹ì´ í—ˆìœ„ ì •ë³´ì˜ ë²½ì— ë§‰íˆë©° ë‚œê´€ì„ ê²ªëŠ”ë‹¤. ê²°êµ­ ì „íˆ¬ë¡œ ì „í™˜.", use_llm=True)
            st.rerun()
    elif st.session_state.sub == "show_s2_choice5_narrative":
        st.markdown(st.session_state.show_narrative)
        if st.button("ë‹¤ìŒ â†’", key="to_choice5_get_keyB", use_container_width=True):
            st.session_state.sub = "choice5_get_keyB"
            st.session_state.show_narrative = ""
            set_checkpoint("story2", "choice5_get_keyB")
            st.rerun()
    elif st.session_state.sub == "choice5_get_keyB":
        st.markdown("**ì„ íƒ ìƒí™©5**: ì—´ì‡  Bë¥¼ ì–´ë–»ê²Œ í™•ë³´í• ê¹Œ?")
        if st.session_state.info_seen["prophecy"]:
            st.caption("ì˜ˆì–¸ì´ ë– ì˜¤ë¥¸ë‹¤: í˜ìœ¼ë¡œ ë¹¼ì•—ëŠ” ë¯¸ë˜ê°€ ì˜ˆì¸¡ë˜ì–´ ìˆì—ˆë‹¤â€¦")
        c1, c2, c3 = st.columns(3)
        with c1:
            if st.button("í˜ìœ¼ë¡œ ë¹¼ì•—ëŠ”ë‹¤", key="s2_choice5_force", use_container_width=True):
                adjust_trust(+5, "ì •ë©´ ìŠ¹ë¶€")
                st.session_state.stage = "story3"
                st.session_state.sub = "show_s3_intro_narrative"
                narrate_llm("ê²©ì „ ëì— ê°€ë¸Œë¦¬ì—˜ì€ ë„ì£¼. ì˜ˆì¸¡ëœ íŒ¨í„´ëŒ€ë¡œ ì›€ì§ì˜€ë‹¤ëŠ” ì°ì°í•¨ì´ ë‚¨ëŠ”ë‹¤.", use_llm=True)
                if "ì—´ì‡  B íšë“" not in st.session_state.investigation:
                    st.session_state.investigation.append("ì—´ì‡  B íšë“")
                st.rerun()
        with c2:
            if st.button("ê°€ë¸Œë¦¬ì—˜ê³¼ ê±°ë˜í•œë‹¤", key="s2_choice5_trade", use_container_width=True):
                adjust_trust(+12, "ìœ„í—˜í•œ ê±°ë˜")
                st.session_state.stage = "story3"
                st.session_state.sub = "show_s3_intro_narrative"
                narrate_llm("ì¼ì‹œì ìœ¼ë¡œ ì—´ì‡ ë¥¼ ì†ì— ë„£ì§€ë§Œ, ì—”í‹°í‹°ì˜ ìƒˆë¡œìš´ ìœ„í˜‘ì´ ë”°ë¼ë¶™ëŠ”ë‹¤.", use_llm=True)
                if "ì—´ì‡  B íšë“" not in st.session_state.investigation:
                    st.session_state.investigation.append("ì—´ì‡  B íšë“")
                st.rerun()
        with c3:
            if st.button("ë‹¤ë¥¸ íŒ€ì›ì—ê²Œ ë§¡ê¸´ë‹¤(ì‹ ë¢° 65â†‘ í•„ìš”)", key="s2_choice5_delegate", use_container_width=True):
                if st.session_state.trust >= 65:
                    adjust_trust(+10, "ì±…ì„ ë¶„ë‹´ ì„±ê³µ")
                    st.session_state.stage = "story3"
                    st.session_state.sub = "show_s3_intro_narrative"
                    narrate_llm("í˜‘ì—…ìœ¼ë¡œ ê¹”ë”í•˜ê²Œ ì—´ì‡  Bë¥¼ í™•ë³´í•œë‹¤.", use_llm=True)
                    if "ì—´ì‡  B íšë“" not in st.session_state.investigation:
                        st.session_state.investigation.append("ì—´ì‡  B íšë“")
                    st.rerun()
                else:
                    adjust_trust(-10, "ë¶ˆì¶©ë¶„í•œ ì‹ ë¢°")
                    st.session_state.stage = "ending"
                    st.session_state.sub = "fail"
                    st.session_state.allow_continue = True
                    narrate_llm("ì‹ ë¢°ê°€ ë¶€ì¡±í•´ ì‹¤ìˆ˜ê°€ ë°œìƒ, ê°€ë¸Œë¦¬ì—˜ì—ê²Œ ì—­ìœ¼ë¡œ ë¹¼ì•—ê²¨ ë¯¸ì…˜ ì‹¤íŒ¨.", use_llm=True)
                    st.rerun()
    elif st.session_state.sub == "s2_fail_narrative":
        st.markdown(st.session_state.show_narrative)
        st.error("ë¯¸ì…˜ ì‹¤íŒ¨. ì²´í¬í¬ì¸íŠ¸ì—ì„œ ë‹¤ì‹œ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")
        st.session_state.allow_continue = True


# ---- STORY3: ì—”í‹°í‹° ë¶•ê´´ ----
if st.session_state.stage == "story3":
    if st.session_state.sub == "show_s3_intro_narrative":
        st.markdown(st.session_state.show_narrative)
        if st.button("ë‹¤ìŒ â†’", key="to_choice6_coords_narrative", use_container_width=True):
            st.session_state.sub = "choice6_coords_narrative"
            st.session_state.show_narrative = ""
            narrate_llm("ì—”í‹°í‹° ì½”ì–´ë¥¼ íŒŒê´´í•˜ê¸° ìœ„í•œ ë§ˆì§€ë§‰ ì„ë¬´. ì—ë‹¨ì´ ì ìˆ˜í•¨ì—ì„œ ë³´ë‚´ì˜¨ ì•”í˜¸í™”ëœ ì¢Œí‘œë¥¼ í•´ë…í•´ì•¼ í•œë‹¤.", use_llm=True)
            st.rerun()
    elif st.session_state.sub == "choice6_coords_narrative":
        st.markdown(st.session_state.show_narrative)
        if st.button("ë‹¤ìŒ â†’", key="to_choice6_coords", use_container_width=True):
            st.session_state.sub = "choice6_coords"
            st.session_state.show_narrative = ""
            set_checkpoint("story3", "choice6_coords")
            st.rerun()
    elif st.session_state.sub == "choice6_coords":
        st.markdown("**ì„ íƒ ìƒí™©6**: ì¢Œí‘œ í•´ì„ â€” [ë‚¨ìœ„ 82.5Â°, ì„œê²½ 65.3Â°] (ìš°ë¦¬ëŠ” ë¶ê·¹í•´)")
        ans = st.text_input("ì—ë‹¨ì´ ì¼ë¶€ëŸ¬ ì´ë ‡ê²Œ ë³´ë‚¸ ì´ìœ ëŠ”?", key="s3_s6")
        if st.button("í•´ì„ ì œì¶œ", key="s3_s6_submit", use_container_width=True):
            st.session_state.attempt_s6 += 1
            txt = (ans or "").strip()
            if any(k in txt for k in ["ë°˜ëŒ€ë¡œ", "ì •ë°˜ëŒ€", "ê±°ê¾¸ë¡œ"]):
                st.session_state.history.append(("user_s6", ans))
                adjust_trust(+10, "ì˜ë„ ê°„íŒŒ")
                narrate_llm("ë‚¨ê·¹/ë¶ê·¹ì„ ë’¤ì§‘ì–´ í•´ì„í•´ ì •í™•í•œ ì¢Œí‘œë¥¼ íŒŒì•…, ì—ë‹¨ê³¼ì˜ êµì‹ ì— ì„±ê³µí•œë‹¤.", use_llm=True)
                st.session_state.sub = "show_s7_narrative"
                st.session_state.attempt_s6 = 0
                st.rerun()
            else:
                st.session_state.history.append(("user_s6_wrong", ans))
                adjust_trust(-10, "ì˜¤í•´")
                if st.session_state.attempt_s6 >= 2:
                    st.info("íŒíŠ¸: ì—ë‹¨ì´ ë³´ë‚¸ ê±´ 'ë‚¨ê·¹í•´' ì¢Œí‘œ. ë‹¹ì‹ ì´ ìˆëŠ” ê³³ì€ 'ë¶ê·¹í•´'.")
                st.rerun()
        if st.session_state.attempt_s6 > 0:
            st.caption(f"ì‹œë„ íšŸìˆ˜: {st.session_state.attempt_s6}/ë¬´ì œí•œ")
    elif st.session_state.sub == "show_s7_narrative":
        st.markdown(st.session_state.show_narrative)
        if st.button("ë‹¤ìŒ â†’", key="to_choice7_timing_intro", use_container_width=True):
            st.session_state.sub = "choice7_timing_intro"
            st.session_state.show_narrative = ""
            st.rerun()
    elif st.session_state.sub == "choice7_timing_intro":
        st.markdown("**ì„ íƒ ìƒí™©7**: ë„¤íŠ¸ì›Œí¬ ì—°ê²° 'ì°°ë‚˜'ì— í¬ì´ì¦Œí•„ì„ ë½‘ì•„ì•¼ í•œë‹¤.")
        st.write("ë¯¸ì…˜ ì„¤ëª…ì„ ìˆ™ì§€í–ˆìœ¼ë©´ ì¤€ë¹„ë¥¼ ëˆŒëŸ¬ íƒ€ì´ë¨¸ë¥¼ ì‹œì‘í•˜ì„¸ìš”. ì¤€ë¹„ í›„ **10ì´ˆ ì´ë‚´**ì— 'ì´ˆë¡ìƒ‰'ì„ ì •í™•íˆ ì…ë ¥í•˜ë©´ ì„±ê³µ!")
        if st.button(f"{st.session_state.player_name}. ì¤€ë¹„ë˜ì…¨ìŠµë‹ˆê¹Œ?", key="s3_ready", use_container_width=True):
            st.session_state.s7_ready_time = time.time()
            st.session_state.sub = "choice7_timing"
            st.rerun()
    elif st.session_state.sub == "choice7_timing":
        ip = st.text_input("ì§€ê¸ˆ! ì…ë ¥í•˜ì„¸ìš” ğŸ‘‰", key="s3_go_input")
        if st.button("ì „ì†¡", key="s3_go_send", use_container_width=True):
            elapsed = time.time() - st.session_state.s7_ready_time
            if ip.strip() == "ì´ˆë¡ìƒ‰" and elapsed <= 10.0:
                adjust_trust(+10, f"ì™„ë²½í•œ íƒ€ì´ë°({elapsed:.1f}s)")
                narrate_llm("í¬ì´ì¦Œí•„ì´ ì ì‹œì— ë½‘íˆë©° ì—”í‹°í‹°ì˜ í†µë¡œê°€ ë´‰ì‡„ëœë‹¤. ë§ˆì§€ë§‰ ë³€ìˆ˜ì— ëŒ€ë¹„í•˜ë¼.", use_llm=True)
                st.session_state.sub = "show_s8_narrative"
            else:
                adjust_trust(-10, f"íƒ€ì´ë° ì‹¤íŒ¨({elapsed:.1f}s)")
                narrate_llm("íƒ€ì´ë°ì„ ë†“ì³ ì—°ê²°ì´ ê¸¸ì–´ì¡Œê³ , ì—”í‹°í‹°ê°€ ë°˜ê²©í•œë‹¤. ë¯¸ì…˜ ì‹¤íŒ¨(ë„¤ ë²ˆì§¸ ì²´í¬í¬ì¸íŠ¸).", use_llm=True)
                st.session_state.sub = "s3_fail_narrative"
                st.session_state.allow_continue = True
            st.session_state.s7_ready_time = None
            st.rerun()
    elif st.session_state.sub == "s3_fail_narrative":
        st.markdown(st.session_state.show_narrative)
        st.error("ë¯¸ì…˜ ì‹¤íŒ¨. ì²´í¬í¬ì¸íŠ¸ì—ì„œ ë‹¤ì‹œ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")
        st.session_state.allow_continue = True
    elif st.session_state.sub == "show_s8_narrative":
        st.markdown(st.session_state.show_narrative)
        if st.button("ë‹¤ìŒ â†’", key="to_choice8_cia_end", use_container_width=True):
            st.session_state.sub = "choice8_cia_end"
            st.session_state.show_narrative = ""
            st.rerun()
    elif st.session_state.sub == "choice8_cia_end":
        st.markdown("**ì„ íƒ ìƒí™©8**: CIAì˜ ë“±ì¥ê³¼ ê²°ë§")
        if st.session_state.reported_to_cia is True:
            st.caption("â€» ë‹¹ì‹ ì€ 2ë‹¨ê³„ì—ì„œ CIAì— ë³´ê³ í–ˆìŠµë‹ˆë‹¤.")
            if st.session_state.trust >= 70:
                narrate_llm("í‚¤íŠ¸ë¦¬ì§€ê°€ ì „ì›ì„ ì²´í¬. í¬ì´ì¦Œí•„ì„ ì••ìˆ˜ë‹¹í•´ **ê²Œì„ ì‹¤íŒ¨**ë¡œ ê·€ê²°ëœë‹¤.", use_llm=True)
                st.session_state.stage = "ending"
                st.session_state.sub = "fail"
                st.rerun()
            else:
                st.write("íŒ€ ì‹ ë¢°ë„ 70 ë¯¸ë§Œ â€” ê²°ë‹¨ì„ ë‚´ë ¤ì•¼ í•œë‹¤.")
                c1, c2 = st.columns(2)
                with c1:
                    if st.button("ë°°ì‹ í•˜ê³  ì—”í‹°í‹°ì˜ í˜ì„ ë…¸ë¦°ë‹¤", key="s3_choice8_betray", use_container_width=True):
                        adjust_trust(-10, "ë°°ì‹ ")
                        narrate_llm("ë„ì£¼ë¥¼ ì‹œë„í–ˆì§€ë§Œ í—¬ê¸°ì— í¬ìœ„ë˜ì–´ ì²´í¬ëœë‹¤. **ë¯¸ì…˜ ì‹¤íŒ¨**.", use_llm=True)
                        st.session_state.stage = "ending"
                        st.session_state.sub = "fail"
                        st.rerun()
                with c2:
                    if st.button("íŒ€ê³¼ í•¨ê»˜ ê°„ë‹¤", key="s3_choice8_withteam", use_container_width=True):
                        adjust_trust(+5, "íŒ€ ë™í–‰")
                        narrate_llm("IMFëŠ” ì²´í¬ë˜ê³  ì—”í‹°í‹°ì˜ í˜ì€ ì •ë¶€ì˜ ì†ìœ¼ë¡œ. **ë¯¸ì…˜ ì‹¤íŒ¨**.", use_llm=True)
                        st.session_state.stage = "ending"
                        st.session_state.sub = "fail"
                        st.rerun()
        else:
            st.caption("â€» ë‹¹ì‹ ì€ 2ë‹¨ê³„ì—ì„œ CIAì— ë³´ê³ í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
            if st.session_state.trust >= 70:
                adjust_trust(+10, "ì—ë‹¨ì˜ ê¸°ì§€")
                narrate_llm("ì—ë‹¨ì´ ë…¼ë¦¬ë¡œ ë°˜ë°•ì— ì„±ê³µ, í¬ì´ì¦Œí•„ì„ ì§€í‚¤ë©° **ë¯¸ì…˜ ì™„ìˆ˜**.", use_llm=True)
                st.session_state.stage = "ending"
                st.session_state.sub = "success"
                st.rerun()
            else:
                st.write("íŒ€ ì‹ ë¢°ë„ 70 ë¯¸ë§Œ â€” ê²°ì • í•„ìš”.")
                c1, c2 = st.columns(2)
                with c1:
                    if st.button("ë°°ì‹ í•˜ê³  í˜ì„ ì¥”ë‹¤", key="s3_choice8_betray2", use_container_width=True):
                        adjust_trust(-10, "ë°°ì‹ ")
                        narrate_llm("ë„ì£¼ë¥¼ ì‹œë„í–ˆì§€ë§Œ í—¬ê¸°ì— í¬ìœ„ë˜ì–´ ì²´í¬ëœë‹¤. **ë¯¸ì…˜ ì‹¤íŒ¨**.", use_llm=True)
                        st.session_state.stage = "ending"
                        st.session_state.sub = "fail"
                        st.rerun()
                with c2:
                    if st.button("íŒ€ê³¼ í•¨ê»˜ ê°„ë‹¤(ì—ë‹¨ ë°˜ë°•)", key="s3_choice8_withteam2", use_container_width=True):
                        adjust_trust(+10, "íŒ€ì›Œí¬ íšŒë³µ")
                        narrate_llm("ì—ë‹¨ì˜ ê¸°ì§€ë¡œ ë°˜ë°•ì— ì„±ê³µ, í¬ì´ì¦Œí•„ê³¼ í•¨ê»˜ **ë¯¸ì…˜ ì™„ìˆ˜**.", use_llm=True)
                        st.session_state.stage = "ending"
                        st.session_state.sub = "success"
                        st.rerun()



# ---- ENDING & RESTART ----
if st.session_state.sub in ["ending_success", "ending_fail"]:
    if st.session_state.sub == "ending_success":
        st.success('**IMF, MISSION COMPLETE.**')
        narrate_llm("ì™„ìˆ˜ ì—”ë”©ì˜ ì—¬ìš´ê³¼ íŒ€ì— ë‚¨ì€ ìƒì²˜, ê·¸ëŸ¬ë‚˜ ì´ì–´ì§ˆ í‰í™”ë¥¼ ì˜í™”ì  ë¬¸ì²´ë¡œ ê°„ê²°íˆ ë§ˆë¬´ë¦¬í•˜ë¼.", use_llm=True)
        st.session_state.sub = "final_narrative"
        st.rerun()
    elif st.session_state.sub == "ending_fail":
        st.error("ë¯¸ì…˜ ì‹¤íŒ¨. ì²´í¬í¬ì¸íŠ¸ì—ì„œ ë‹¤ì‹œ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")
        st.session_state.allow_continue = True

if st.session_state.sub == "final_narrative":
    st.markdown(st.session_state.show_narrative)
    st.session_state.game_over = True
    st.stop()
    
if st.session_state.allow_continue:
    c1, c2 = st.columns(2)
    with c1:
        if st.button("ì²´í¬í¬ì¸íŠ¸ì—ì„œ ì¬ê°œ", key="retry_checkpoint", use_container_width=True):
            restore_checkpoint()
            narrate_llm("ê°€ì¥ ê°€ê¹Œìš´ ì²´í¬í¬ì¸íŠ¸ë¡œ ë³µê·€í•œë‹¤. ì‹ ë¢°ë„ëŠ” 50ìœ¼ë¡œ ë¦¬ì…‹ë˜ì—ˆë‹¤.", use_llm=False)
            st.session_state.sub = st.session_state.checkpoint[1]
            st.rerun()
    with c2:
        if st.button("ê·¸ë§Œí•˜ê¸°", key="retry_quit", use_container_width=True):
            st.session_state.game_over = True
            st.rerun()